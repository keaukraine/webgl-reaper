class t{enterFullScreen(){document.fullscreenElement||document.documentElement.requestFullscreen({navigationUI:"hide"})}exitFullScreen(){document.exitFullscreen&&document.exitFullscreen()}addFullScreenListener(t){document.addEventListener("fullscreenchange",t,!1)}isFullScreen(){return!!document.fullscreenElement}}class e{static async load(t){return(await fetch(t)).arrayBuffer()}}class i{static load(t,e,i=e.LINEAR,r=e.LINEAR,s=!1){return new Promise(((o,n)=>{const a=e.createTexture();if(null===a)return void n("Error creating WebGL texture");const h=new Image;h.src=t,h.onload=()=>{e.bindTexture(e.TEXTURE_2D,a),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,h),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,i),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,r),!0===s?(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE)):(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT)),e.bindTexture(e.TEXTURE_2D,null),h&&h.src&&console.log(`Loaded texture ${t} [${h.width}x${h.height}]`),o(a)},h.onerror=()=>n("Cannot load image")}))}static async loadCubemap(t,e){const i=e.createTexture();if(null===i)throw new Error("Error creating WebGL texture");e.bindTexture(e.TEXTURE_CUBE_MAP,i),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MIN_FILTER,e.NEAREST);const r=[{type:e.TEXTURE_CUBE_MAP_POSITIVE_X,suffix:"-posx.png"},{type:e.TEXTURE_CUBE_MAP_NEGATIVE_X,suffix:"-negx.png"},{type:e.TEXTURE_CUBE_MAP_POSITIVE_Y,suffix:"-posy.png"},{type:e.TEXTURE_CUBE_MAP_NEGATIVE_Y,suffix:"-negy.png"},{type:e.TEXTURE_CUBE_MAP_POSITIVE_Z,suffix:"-posz.png"},{type:e.TEXTURE_CUBE_MAP_NEGATIVE_Z,suffix:"-negz.png"}].map((r=>new Promise(((s,o)=>{const n=new Image;n.src=t+r.suffix,n.onload=()=>{e.bindTexture(e.TEXTURE_CUBE_MAP,i),e.texImage2D(r.type,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,n),n&&n.src&&console.log(`Loaded texture ${t}${r.suffix} [${n.width}x${n.height}]`),s()},n.onerror=()=>o("Cannot load image")}))));return await Promise.all(r),e.bindTexture(e.TEXTURE_2D,null),i}}class r{constructor(){this.numIndices=0}loadBuffer(t,e,i,r){var s=new Uint8Array(r,0,r.byteLength);t.bindBuffer(i,e),t.bufferData(i,s,t.STATIC_DRAW)}async load(t,i){const r=await e.load(t+"-indices.bin"),s=await e.load(t+"-strides.bin");console.log(`Loaded ${t}-indices.bin (${r.byteLength} bytes)`),console.log(`Loaded ${t}-strides.bin (${s.byteLength} bytes)`),this.bufferIndices=i.createBuffer(),this.loadBuffer(i,this.bufferIndices,i.ELEMENT_ARRAY_BUFFER,r),this.numIndices=r.byteLength/2/3,this.bufferStrides=i.createBuffer(),this.loadBuffer(i,this.bufferStrides,i.ARRAY_BUFFER,s)}bindBuffers(t){t.bindBuffer(t.ARRAY_BUFFER,this.bufferStrides),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.bufferIndices)}getNumIndices(){return this.numIndices}}class s{constructor(t){this.gl=t,this.vertexShaderCode="",this.fragmentShaderCode="",this.fillCode(),this.initShader()}getShader(t,e){const i=this.gl.createShader(t);if(i){if(this.gl.shaderSource(i,e),this.gl.compileShader(i),this.gl.getShaderParameter(i,this.gl.COMPILE_STATUS))return i;console.warn(this.gl.getShaderInfoLog(i))}else console.warn("Error creating shader.")}getUniform(t){if(void 0===this.program)throw new Error("No program for shader.");const e=this.gl.getUniformLocation(this.program,t);if(null!==e)return e;throw new Error(`Cannot get uniform "${t}".`)}getAttrib(t){if(void 0===this.program)throw new Error("No program for shader.");return this.gl.getAttribLocation(this.program,t)}initShader(){const t=this.getShader(this.gl.FRAGMENT_SHADER,this.fragmentShaderCode),e=this.getShader(this.gl.VERTEX_SHADER,this.vertexShaderCode),i=this.gl.createProgram();void 0!==t&&void 0!==e&&null!==i&&(this.gl.attachShader(i,e),this.gl.attachShader(i,t),this.gl.linkProgram(i),this.gl.getProgramParameter(i,this.gl.LINK_STATUS)?console.log(this.constructor.name+": Initialised shader"):console.warn(this.constructor.name+": Could not initialise shader"),this.gl.useProgram(i),this.program=i,this.fillUniformsAttributes())}use(){this.program&&this.gl.useProgram(this.program)}deleteProgram(){this.program&&this.gl.deleteProgram(this.program)}}var o="undefined"!=typeof Float32Array?Float32Array:Array;function n(){var t=new o(16);return o!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function a(t,e,i){var r=e[0],s=e[1],o=e[2],n=e[3],a=e[4],h=e[5],l=e[6],d=e[7],u=e[8],m=e[9],c=e[10],g=e[11],f=e[12],T=e[13],x=e[14],E=e[15],_=i[0],A=i[1],p=i[2],v=i[3];return t[0]=_*r+A*a+p*u+v*f,t[1]=_*s+A*h+p*m+v*T,t[2]=_*o+A*l+p*c+v*x,t[3]=_*n+A*d+p*g+v*E,_=i[4],A=i[5],p=i[6],v=i[7],t[4]=_*r+A*a+p*u+v*f,t[5]=_*s+A*h+p*m+v*T,t[6]=_*o+A*l+p*c+v*x,t[7]=_*n+A*d+p*g+v*E,_=i[8],A=i[9],p=i[10],v=i[11],t[8]=_*r+A*a+p*u+v*f,t[9]=_*s+A*h+p*m+v*T,t[10]=_*o+A*l+p*c+v*x,t[11]=_*n+A*d+p*g+v*E,_=i[12],A=i[13],p=i[14],v=i[15],t[12]=_*r+A*a+p*u+v*f,t[13]=_*s+A*h+p*m+v*T,t[14]=_*o+A*l+p*c+v*x,t[15]=_*n+A*d+p*g+v*E,t}function h(){var t=new o(3);return o!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function l(t,e,i){var r=new o(3);return r[0]=t,r[1]=e,r[2]=i,r}function d(t,e,i){var r=e[0],s=e[1],o=e[2],n=i[0],a=i[1],h=i[2];return t[0]=s*h-o*a,t[1]=o*n-r*h,t[2]=r*a-s*n,t}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});var u,m=function(t){var e=t[0],i=t[1],r=t[2];return Math.hypot(e,i,r)};u=h();!function(){var t,e=(t=new o(4),o!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t)}();function c(){var t=new o(4);return o!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function g(t,e,i,r){var s,o,n,a,h,l=e[0],d=e[1],u=e[2],m=e[3],c=i[0],g=i[1],f=i[2],T=i[3];return(o=l*c+d*g+u*f+m*T)<0&&(o=-o,c=-c,g=-g,f=-f,T=-T),1-o>1e-6?(s=Math.acos(o),n=Math.sin(s),a=Math.sin((1-r)*s)/n,h=Math.sin(r*s)/n):(a=1-r,h=r),t[0]=a*l+h*c,t[1]=a*d+h*g,t[2]=a*u+h*f,t[3]=a*m+h*T,t}var f,T,x,E,_,A,p,v=function(t,e){var i=e[0],r=e[1],s=e[2],o=e[3],n=i*i+r*r+s*s+o*o;return n>0&&(n=1/Math.sqrt(n)),t[0]=i*n,t[1]=r*n,t[2]=s*n,t[3]=o*n,t};f=h(),T=l(1,0,0),x=l(0,1,0),E=c(),_=c(),A=new o(9),o!=Float32Array&&(A[1]=0,A[2]=0,A[3]=0,A[5]=0,A[6]=0,A[7]=0),A[0]=1,A[4]=1,A[8]=1,p=A;!function(){var t=function(){var t=new o(2);return o!=Float32Array&&(t[0]=0,t[1]=0),t}()}();class S{constructor(t){this.gl=t,this.m_textureHandle=null,this.m_depthTextureHandle=null,this.m_framebufferHandle=null,this.m_depthbufferHandle=null}createGLData(t,e){if(this.m_width=t,this.m_height=e,null!==this.m_textureHandle&&this.m_width>0&&this.m_height>0){this.m_framebufferHandle=this.gl.createFramebuffer(),null!==this.m_textureHandle&&(this.gl.bindTexture(this.gl.TEXTURE_2D,this.m_textureHandle),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.m_framebufferHandle),this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,this.m_textureHandle,0),this.checkGlError("FB")),null===this.m_depthTextureHandle?(this.m_depthbufferHandle=this.gl.createRenderbuffer(),this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this.m_depthbufferHandle),this.checkGlError("FB - glBindRenderbuffer"),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.gl.DEPTH_COMPONENT16,this.m_width,this.m_height),this.checkGlError("FB - glRenderbufferStorage"),this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,this.gl.DEPTH_ATTACHMENT,this.gl.RENDERBUFFER,this.m_depthbufferHandle),this.checkGlError("FB - glFramebufferRenderbuffer")):(this.gl.bindTexture(this.gl.TEXTURE_2D,this.m_depthTextureHandle),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.m_framebufferHandle),this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.DEPTH_ATTACHMENT,this.gl.TEXTURE_2D,this.m_depthTextureHandle,0),this.checkGlError("FB depth"));const t=this.gl.checkFramebufferStatus(this.gl.FRAMEBUFFER);t!=this.gl.FRAMEBUFFER_COMPLETE&&console.error(`Error creating framebufer: ${t}`),this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,null),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null)}}checkGlError(t){let e;for(;(e=this.gl.getError())!==this.gl.NO_ERROR;)console.error(`${t}: glError ${e}`)}get width(){return this.m_width}set width(t){this.m_width=t}get height(){return this.m_height}set height(t){this.m_height=t}get textureHandle(){return this.m_textureHandle}set textureHandle(t){this.m_textureHandle=t}get depthbufferHandle(){return this.m_depthbufferHandle}set depthbufferHandle(t){this.m_depthbufferHandle=t}get framebufferHandle(){return this.m_framebufferHandle}set framebufferHandle(t){this.m_framebufferHandle=t}get depthTextureHandle(){return this.m_depthTextureHandle}set depthTextureHandle(t){this.m_depthTextureHandle=t}}class R{static createNpotTexture(t,e,i,r=!1){const s=t.createTexture();t.bindTexture(t.TEXTURE_2D,s),t.texParameterf(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameterf(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);let o=null,n=null;return r?(o=t.RGBA,n=t.RGBA):(o=t.RGB,n=t.RGB),t.texImage2D(t.TEXTURE_2D,0,n,e,i,0,o,t.UNSIGNED_BYTE,null),s}static createDepthTexture(t,e,i){const r=t.createTexture();t.bindTexture(t.TEXTURE_2D,r),t.texParameterf(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameterf(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);const s=t.getParameter(t.VERSION)||"",o=t.DEPTH_COMPONENT,n=s.includes("WebGL 2")?t.DEPTH_COMPONENT16:t.DEPTH_COMPONENT,a=t.UNSIGNED_SHORT;return t.texImage2D(t.TEXTURE_2D,0,n,e,i,0,o,a,null),r}}class C extends s{fillCode(){this.vertexShaderCode="uniform mat4 view_proj_matrix;\nattribute vec4 rm_Vertex;\nattribute vec2 rm_TexCoord0;\nvarying vec2 vTextureCoord;\n\nvoid main() {\n  gl_Position = view_proj_matrix * rm_Vertex;\n  vTextureCoord = rm_TexCoord0;\n}",this.fragmentShaderCode="precision mediump float;\nvarying vec2 vTextureCoord;\nuniform sampler2D sTexture;\n\nvoid main() {\n  gl_FragColor = texture2D(sTexture, vTextureCoord);\n}"}fillUniformsAttributes(){this.view_proj_matrix=this.getUniform("view_proj_matrix"),this.rm_Vertex=this.getAttrib("rm_Vertex"),this.rm_TexCoord0=this.getAttrib("rm_TexCoord0"),this.sTexture=this.getUniform("sTexture")}drawModel(t,e,i,r,s,o,n,a,h,l,d){if(void 0===this.rm_Vertex||void 0===this.rm_TexCoord0||void 0===this.view_proj_matrix)return;const u=t.gl;e.bindBuffers(u),u.enableVertexAttribArray(this.rm_Vertex),u.enableVertexAttribArray(this.rm_TexCoord0),u.vertexAttribPointer(this.rm_Vertex,3,u.FLOAT,!1,20,0),u.vertexAttribPointer(this.rm_TexCoord0,2,u.FLOAT,!1,20,12),t.calculateMVPMatrix(i,r,s,o,n,a,h,l,d),u.uniformMatrix4fv(this.view_proj_matrix,!1,t.getMVPMatrix()),u.drawElements(u.TRIANGLES,3*e.getNumIndices(),u.UNSIGNED_SHORT,0),t.checkGlError("DiffuseShader glDrawElements")}}var y="undefined"!=typeof Float32Array?Float32Array:Array,M=Math.random;function w(){var t=new y(16);return y!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function D(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function P(t,e){var i=e[0],r=e[1],s=e[2],o=e[3],n=e[4],a=e[5],h=e[6],l=e[7],d=e[8],u=e[9],m=e[10],c=e[11],g=e[12],f=e[13],T=e[14],x=e[15],E=i*a-r*n,_=i*h-s*n,A=i*l-o*n,p=r*h-s*a,v=r*l-o*a,S=s*l-o*h,R=d*f-u*g,C=d*T-m*g,y=d*x-c*g,M=u*T-m*f,w=u*x-c*f,D=m*x-c*T,P=E*D-_*w+A*M+p*y-v*C+S*R;return P?(P=1/P,t[0]=(a*D-h*w+l*M)*P,t[1]=(s*w-r*D-o*M)*P,t[2]=(f*S-T*v+x*p)*P,t[3]=(m*v-u*S-c*p)*P,t[4]=(h*y-n*D-l*C)*P,t[5]=(i*D-s*y+o*C)*P,t[6]=(T*A-g*S-x*_)*P,t[7]=(d*S-m*A+c*_)*P,t[8]=(n*w-a*y+l*R)*P,t[9]=(r*y-i*w-o*R)*P,t[10]=(g*v-f*A+x*E)*P,t[11]=(u*A-d*v-c*E)*P,t[12]=(a*C-n*M-h*R)*P,t[13]=(i*M-r*C+s*R)*P,t[14]=(f*_-g*p-T*E)*P,t[15]=(d*p-u*_+m*E)*P,t):null}function F(t,e,i){var r=e[0],s=e[1],o=e[2],n=e[3],a=e[4],h=e[5],l=e[6],d=e[7],u=e[8],m=e[9],c=e[10],g=e[11],f=e[12],T=e[13],x=e[14],E=e[15],_=i[0],A=i[1],p=i[2],v=i[3];return t[0]=_*r+A*a+p*u+v*f,t[1]=_*s+A*h+p*m+v*T,t[2]=_*o+A*l+p*c+v*x,t[3]=_*n+A*d+p*g+v*E,_=i[4],A=i[5],p=i[6],v=i[7],t[4]=_*r+A*a+p*u+v*f,t[5]=_*s+A*h+p*m+v*T,t[6]=_*o+A*l+p*c+v*x,t[7]=_*n+A*d+p*g+v*E,_=i[8],A=i[9],p=i[10],v=i[11],t[8]=_*r+A*a+p*u+v*f,t[9]=_*s+A*h+p*m+v*T,t[10]=_*o+A*l+p*c+v*x,t[11]=_*n+A*d+p*g+v*E,_=i[12],A=i[13],p=i[14],v=i[15],t[12]=_*r+A*a+p*u+v*f,t[13]=_*s+A*h+p*m+v*T,t[14]=_*o+A*l+p*c+v*x,t[15]=_*n+A*d+p*g+v*E,t}function b(t,e,i){var r,s,o,n,a,h,l,d,u,m,c,g,f=i[0],T=i[1],x=i[2];return e===t?(t[12]=e[0]*f+e[4]*T+e[8]*x+e[12],t[13]=e[1]*f+e[5]*T+e[9]*x+e[13],t[14]=e[2]*f+e[6]*T+e[10]*x+e[14],t[15]=e[3]*f+e[7]*T+e[11]*x+e[15]):(r=e[0],s=e[1],o=e[2],n=e[3],a=e[4],h=e[5],l=e[6],d=e[7],u=e[8],m=e[9],c=e[10],g=e[11],t[0]=r,t[1]=s,t[2]=o,t[3]=n,t[4]=a,t[5]=h,t[6]=l,t[7]=d,t[8]=u,t[9]=m,t[10]=c,t[11]=g,t[12]=r*f+a*T+u*x+e[12],t[13]=s*f+h*T+m*x+e[13],t[14]=o*f+l*T+c*x+e[14],t[15]=n*f+d*T+g*x+e[15]),t}function I(t,e,i){var r=Math.sin(i),s=Math.cos(i),o=e[4],n=e[5],a=e[6],h=e[7],l=e[8],d=e[9],u=e[10],m=e[11];return e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=o*s+l*r,t[5]=n*s+d*r,t[6]=a*s+u*r,t[7]=h*s+m*r,t[8]=l*s-o*r,t[9]=d*s-n*r,t[10]=u*s-a*r,t[11]=m*s-h*r,t}function L(t,e,i){var r=Math.sin(i),s=Math.cos(i),o=e[0],n=e[1],a=e[2],h=e[3],l=e[8],d=e[9],u=e[10],m=e[11];return e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=o*s-l*r,t[1]=n*s-d*r,t[2]=a*s-u*r,t[3]=h*s-m*r,t[8]=o*r+l*s,t[9]=n*r+d*s,t[10]=a*r+u*s,t[11]=h*r+m*s,t}function U(t,e,i){var r=Math.sin(i),s=Math.cos(i),o=e[0],n=e[1],a=e[2],h=e[3],l=e[4],d=e[5],u=e[6],m=e[7];return e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=o*s+l*r,t[1]=n*s+d*r,t[2]=a*s+u*r,t[3]=h*s+m*r,t[4]=l*s-o*r,t[5]=d*s-n*r,t[6]=u*s-a*r,t[7]=m*s-h*r,t}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});var O=function(t,e,i,r,s,o,n){var a=1/(e-i),h=1/(r-s),l=1/(o-n);return t[0]=-2*a,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*h,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*l,t[11]=0,t[12]=(e+i)*a,t[13]=(s+r)*h,t[14]=(n+o)*l,t[15]=1,t};function N(){var t=new y(3);return y!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}var k;!function(){var t=N()}();class B extends C{constructor(){super(...arguments),this._color=[1,1,0,0]}fillCode(){super.fillCode(),this.fragmentShaderCode="precision mediump float;\n            varying vec2 vTextureCoord;\n            uniform sampler2D sTexture;\n            uniform vec4 color;\n\n            void main() {\n                gl_FragColor = texture2D(sTexture, vTextureCoord) * color;\n            }"}fillUniformsAttributes(){super.fillUniformsAttributes(),this.color=this.getUniform("color")}setColor(t,e,i,r){this._color=[t,e,i,r]}drawModel(t,e,i,r,s,o,n,a,h,l,d){if(void 0===this.rm_Vertex||void 0===this.view_proj_matrix||void 0===this.color)return;t.gl.uniform4f(this.color,this._color[0],this._color[1],this._color[2],this._color[3]),super.drawModel(t,e,i,r,s,o,n,a,h,l,d)}}class H extends C{constructor(){super(...arguments),this._color=[1,1,0,0],this._radius=50,this._length=1}fillCode(){this.vertexShaderCode="\n            uniform mat4 view_proj_matrix;\n            attribute vec4 rm_Vertex;\n            attribute vec2 rm_TexCoord0;\n            varying vec2 vTextureCoord;\n            uniform float R;\n            uniform float lengthToRadius;\n            \n            void main() {\n              float theta = rm_Vertex.x * lengthToRadius;\n\n              gl_Position = view_proj_matrix * vec4(R * sin(theta), R * cos(theta), rm_Vertex.z, 1.0);\n              vTextureCoord = rm_TexCoord0;\n            }",this.fragmentShaderCode="precision mediump float;\n            varying vec2 vTextureCoord;\n            uniform sampler2D sTexture;\n            uniform vec4 color;\n\n            void main() {\n                float alpha = texture2D(sTexture, vTextureCoord).r * color.a;\n                gl_FragColor = vec4(color.rgb * alpha, alpha);\n                //gl_FragColor = texture2D(sTexture, vTextureCoord) * color;\n            }"}fillUniformsAttributes(){super.fillUniformsAttributes(),this.color=this.getUniform("color"),this.radius=this.getUniform("R"),this.lengthToRadius=this.getUniform("lengthToRadius")}setColor(t,e,i,r){this._color=[t,e,i,r]}setRadius(t){this._radius=t}setLength(t){this._length=t}drawModel(t,e,i,r,s,o,n,a,h,l,d){if(void 0===this.rm_Vertex||void 0===this.view_proj_matrix||void 0===this.color||null==this.radius||null==this.lengthToRadius)return;const u=t.gl;u.uniform4f(this.color,this._color[0],this._color[1],this._color[2],this._color[3]),u.uniform1f(this.radius,this._radius),u.uniform1f(this.lengthToRadius,this._length/this._radius),super.drawModel(t,e,i,r,s,o,n,a,h,l,d)}}!function(t){t[t.Rotating=0]="Rotating",t[t.Random=1]="Random"}(k||(k={}));class V{constructor(){this._speed=0,this.duration=0,this._minDuration=3e3,this._timer=0,this.lastTime=0,this._reverse=!1,this._cameraPosition=N(),this._cameraRotation=N(),this._matrix=w()}get cameraPosition(){return this._cameraPosition}get cameraRotation(){return this._cameraRotation}set reverse(t){this._reverse=t}set minDuration(t){this._minDuration=t}get matrix(){return this._matrix}get speed(){return this._speed}set speed(t){this._speed=t}get position(){return this._position}set position(t){this._position=t,this.duration=Math.max(this.getLength()/this.speed,this._minDuration)}get timer(){return this._timer}getLength(){if(void 0===this.position)return 0;const t=this.position.start.position,e=this.position.end.position;return Math.sqrt((e[0]-t[0])**2+(e[1]-t[1])**2+(e[2]-t[2])**2)}iterate(t){if(0!=this.lastTime){const e=t-this.lastTime;this._timer+=e/this.duration,this._timer>1&&(this._timer=1)}this.lastTime=t,this.updateMatrix()}reset(){this._timer=0,this.updateMatrix()}updateMatrix(){if(void 0===this._position)return;const t=this._reverse?this._position.end:this._position.start,e=this._reverse?this._position.start:this._position.end;this._cameraPosition[0]=t.position[0]+this._timer*(e.position[0]-t.position[0]),this._cameraPosition[1]=t.position[1]+this._timer*(e.position[1]-t.position[1]),this._cameraPosition[2]=t.position[2]+this._timer*(e.position[2]-t.position[2]),this._cameraRotation[0]=t.rotation[0]+this._timer*(e.rotation[0]-t.rotation[0]),this._cameraRotation[1]=t.rotation[1]+this._timer*(e.rotation[1]-t.rotation[1]),this._cameraRotation[2]=t.rotation[2]+this._timer*(e.rotation[2]-t.rotation[2]),D(this.matrix),I(this.matrix,this.matrix,this._cameraRotation[0]-Math.PI/2),U(this.matrix,this.matrix,this._cameraRotation[1]),L(this.matrix,this.matrix,this._cameraRotation[2]),b(this.matrix,this.matrix,[-this._cameraPosition[0],-this._cameraPosition[1],-this._cameraPosition[2]])}}class G extends C{fillCode(){super.fillCode(),this.fragmentShaderCode="precision mediump float;\n            varying vec2 vTextureCoord;\n            uniform sampler2D sTexture;\n            uniform sampler2D sAlphaTexture;\n\n            void main() {\n                float alpha = texture2D(sAlphaTexture, vTextureCoord).r;\n                gl_FragColor = texture2D(sTexture, vTextureCoord);\n                gl_FragColor.rgb *= alpha;\n                gl_FragColor.a = alpha;\n            }"}fillUniformsAttributes(){super.fillUniformsAttributes(),this.sAlphaTexture=this.getUniform("sAlphaTexture")}}class X extends C{fillCode(){this.vertexShaderCode="#version 300 es\nprecision highp float;\nuniform sampler2D sPositions;\nuniform vec3 uTexelSizes; // x = vertex count; y = texel half width; z = sampler y coord (animation frame)\nuniform mat4 view_proj_matrix;\nin vec2 rm_TexCoord0;\nout vec2 vTextureCoord;\n\nvoid main() {\n  float id = float(gl_VertexID);  vec4 position = texture(sPositions, vec2(id / uTexelSizes.x + uTexelSizes.y, uTexelSizes.z));  gl_Position = view_proj_matrix * position;\n  vTextureCoord = rm_TexCoord0;\n}",this.fragmentShaderCode="#version 300 es\nprecision mediump float;\nin vec2 vTextureCoord;\nuniform sampler2D sTexture;\nout vec4 fragColor;\n\nvoid main() {\n  fragColor = texture(sTexture, vTextureCoord);\n}"}fillUniformsAttributes(){this.view_proj_matrix=this.getUniform("view_proj_matrix"),this.rm_TexCoord0=this.getAttrib("rm_TexCoord0"),this.sTexture=this.getUniform("sTexture"),this.sPositions=this.getUniform("sPositions"),this.uTexelSizes=this.getUniform("uTexelSizes")}drawModel(t,e,i,r,s,o,n,a,h,l,d){if(void 0===this.rm_TexCoord0||void 0===this.view_proj_matrix)return;const u=t.gl;e.bindBuffers(u),u.enableVertexAttribArray(this.rm_TexCoord0),u.vertexAttribPointer(this.rm_TexCoord0,2,u.HALF_FLOAT,!1,4,0),t.calculateMVPMatrix(i,r,s,o,n,a,h,l,d),u.uniformMatrix4fv(this.view_proj_matrix,!1,t.getMVPMatrix()),u.drawElements(u.TRIANGLES,3*e.getNumIndices(),u.UNSIGNED_SHORT,0),t.checkGlError("DiffuseShader glDrawElements")}}class z extends X{fillCode(){super.fillCode(),this.vertexShaderCode="#version 300 es\nprecision highp float;\nuniform sampler2D sPositions;\n// x = texture width; y = texel half width; z = sampler y coord (animation frame); w = chunk size\nuniform vec4 uTexelSizes;\nuniform float uTexelHeight;\nuniform int uTextureWidthInt;\nuniform mat4 view_proj_matrix;\nin vec2 rm_TexCoord0;\nout vec2 vTextureCoord;\n\nfloat getCenter(float y) {\n  return y - mod(y, uTexelHeight) + uTexelHeight * 0.5;\n}\n\nvec4 linearFilter(vec2 coords) {\n  vec2 coords1 = vec2(coords.x, coords.y - uTexelHeight * 0.49);\n  vec2 coords2 = vec2(coords.x, coords.y + uTexelHeight * 0.49);\n  float center1 = getCenter(coords1.y);\n  float center2 = getCenter(coords2.y);\n  vec4 v1 = texture(sPositions, vec2(coords1.x, center1));\n  vec4 v2 = texture(sPositions, vec2(coords2.x, center2));\n  float d1 = abs(coords.y - center1);\n  float d2 = abs(coords.y - center2);\n  if (d1 > d2) {\n    return mix( v1, v2, d1 / (uTexelHeight) );\n  } else {\n    return mix( v2, v1, d2 / (uTexelHeight) );\n  }\n}\n\nvoid main() {\n  float id = float(gl_VertexID % uTextureWidthInt);  float chunk = float(gl_VertexID / uTextureWidthInt);  vec2 coords = vec2(id / uTexelSizes.x + uTexelSizes.y, uTexelSizes.z);  coords.y += chunk * uTexelSizes.w;  vec4 position = linearFilter(coords);  gl_Position = view_proj_matrix * position;\n  vTextureCoord = rm_TexCoord0;\n}"}fillUniformsAttributes(){super.fillUniformsAttributes(),this.uTextureWidthInt=this.getUniform("uTextureWidthInt"),this.uTexelHeight=this.getUniform("uTexelHeight")}}class W{constructor(t,e,i){this.m_frames=0,this.m_vertices=0,this.m_texelHalfWidth=0,this.m_texelHalfHeight=0,this.m_texelHeight=0,this.m_textureWidth=0,this.m_textureHeight=0,this.m_chunkSize=0,this.m_textureWidth=t,this.m_vertices=e,this.m_frames=i,this.m_textureHeight=Math.ceil(e/t)*(i+1),this.m_texelHalfWidth=1/t*.5,this.m_texelHalfHeight=1/this.m_textureHeight*.5,this.m_texelHeight=1/this.m_textureHeight,this.m_chunkSize=1/Math.ceil(e/t)}get chunkSize(){return this.m_chunkSize}get vertices(){return this.m_vertices}get frames(){return this.m_frames}get texelHalfWidth(){return this.m_texelHalfWidth}get texelHalfHeight(){return this.m_texelHalfHeight}get textureWidth(){return this.m_textureWidth}get textureHeight(){return this.m_textureHeight}animateStartEndStart(t){const e=t<.5?2*t:2*(1-t);return this.m_texelHeight*e*(this.frames-1)+this.m_texelHalfHeight}animateStartToEnd(t){return this.m_texelHeight*t*(this.frames-1)+this.m_texelHalfHeight}}class j extends s{fillCode(){this.vertexShaderCode="uniform mat4 uMvp;\nuniform float uThickness;\n\nattribute vec4 aPosition;\n\nvoid main() {\n    vec4 position = uMvp * aPosition;\n    gl_PointSize = uThickness;\n    gl_Position =  position;\n}",this.fragmentShaderCode="precision mediump float;\nuniform sampler2D tex0;\nuniform vec4 color;\n\nvoid main() \n{\n   gl_FragColor = texture2D(tex0, gl_PointCoord) * color;\n}"}fillUniformsAttributes(){this.uMvp=this.getUniform("uMvp"),this.uThickness=this.getUniform("uThickness"),this.aPosition=this.getAttrib("aPosition"),this.tex0=this.getUniform("tex0"),this.color=this.getUniform("color")}}class K extends z{fillCode(){super.fillCode(),this.fragmentShaderCode="#version 300 es\nprecision mediump float;\nin vec2 vTextureCoord;\nuniform sampler2D sTexture;\nout vec4 fragColor;\n\nvoid main() {\n  vec4 color = texture(sTexture, vTextureCoord);\n  fragColor = color;\n  if (fragColor.a < 0.1) {\n    discard;\n  }\n}"}}class $ extends z{fillCode(){this.vertexShaderCode="#version 300 es\nprecision highp float;\nuniform sampler2D sPositions;\nuniform sampler2D sNormals;\n// x = texture width; y = texel half width; z = sampler y coord (animation frame); w = chunk size\nuniform vec4 uTexelSizes;\nuniform float uTexelHeight;\nuniform int uTextureWidthInt;\nuniform vec4 uLightDir;\nuniform float uLightIntensity;\nuniform mat4 view_proj_matrix;\nin vec2 rm_TexCoord0;\nout vec2 vTextureCoord;\nout float vVertexLight;\n\nfloat getCenter(float y) {\n  return y - mod(y, uTexelHeight) + uTexelHeight * 0.5;\n}\n\nvec4 linearFilter(vec2 coords, sampler2D sTexture) {\n  vec2 coords1 = vec2(coords.x, coords.y - uTexelHeight * 0.49);\n  vec2 coords2 = vec2(coords.x, coords.y + uTexelHeight * 0.49);\n  float center1 = getCenter(coords1.y);\n  float center2 = getCenter(coords2.y);\n  vec4 v1 = texture(sTexture, vec2(coords1.x, center1));\n  vec4 v2 = texture(sTexture, vec2(coords2.x, center2));\n  float d1 = abs(coords.y - center1);\n  float d2 = abs(coords.y - center2);\n  if (d1 > d2) {\n    return mix( v1, v2, d1 / (uTexelHeight) );\n  } else {\n    return mix( v2, v1, d2 / (uTexelHeight) );\n  }\n}\n\nvoid main() {\n  float id = float(gl_VertexID % uTextureWidthInt);  float chunk = float(gl_VertexID / uTextureWidthInt);  vec2 coords = vec2(id / uTexelSizes.x + uTexelSizes.y, uTexelSizes.z);  coords.y += chunk * uTexelSizes.w;  vec4 position = linearFilter(coords, sPositions);  vec4 normal = linearFilter(coords, sNormals);  gl_Position = view_proj_matrix * position;\n  vTextureCoord = rm_TexCoord0;\n  float d = pow( max(0.0, dot(normal, uLightDir)), 5.0 );\n  vVertexLight = d * uLightIntensity;\n}",this.fragmentShaderCode="#version 300 es\nprecision mediump float;\nin vec2 vTextureCoord;\nin float vVertexLight;\nuniform sampler2D sTexture;\nuniform vec4 uLightColor;\nout vec4 fragColor;\n\nvoid main() {\n  vec4 color = texture(sTexture, vTextureCoord);\n  vec4 highlight = color + uLightColor;\n  fragColor = mix(color, highlight, vVertexLight);\n}"}fillUniformsAttributes(){super.fillUniformsAttributes(),this.sNormals=this.getUniform("sNormals"),this.uLightDir=this.getUniform("uLightDir"),this.uLightColor=this.getUniform("uLightColor"),this.uLightIntensity=this.getUniform("uLightIntensity")}}class Y extends C{fillCode(){this.vertexShaderCode="uniform mat4 view_proj_matrix;\nattribute vec4 rm_Vertex;\nattribute vec2 rm_TexCoord0;\nvarying vec2 vTextureCoord;\n\nvoid main() {\n  gl_Position = view_proj_matrix * rm_Vertex;\n  vTextureCoord = rm_TexCoord0;\n}",this.fragmentShaderCode="precision highp float;\nuniform vec2 uCameraRange;\nuniform vec2 uInvViewportSize;\nuniform float uTransitionSize;\nfloat calc_depth(in float z)\n{\n  return (2.0 * uCameraRange.x) / (uCameraRange.y + uCameraRange.x - z*(uCameraRange.y - uCameraRange.x));\n}\nuniform sampler2D sDepth;\nvarying vec2 vTextureCoord;\nuniform sampler2D sTexture;\nuniform vec4 color;\n\nvoid main() {\n   vec4 diffuse = texture2D(sTexture, vTextureCoord) * color;\n   vec2 coords = gl_FragCoord.xy * uInvViewportSize;\n   float geometryZ = calc_depth(texture2D(sDepth, coords).r);\n   float sceneZ = calc_depth(gl_FragCoord.z);\n   float a = clamp(geometryZ - sceneZ, 0.0, 1.0);\n   float b = smoothstep(0.0, uTransitionSize, a);\n   gl_FragColor = diffuse * b;\n}"}fillUniformsAttributes(){this.view_proj_matrix=this.getUniform("view_proj_matrix"),this.rm_Vertex=this.getAttrib("rm_Vertex"),this.rm_TexCoord0=this.getAttrib("rm_TexCoord0"),this.sTexture=this.getUniform("sTexture"),this.cameraRange=this.getUniform("uCameraRange"),this.sDepth=this.getUniform("sDepth"),this.invViewportSize=this.getUniform("uInvViewportSize"),this.transitionSize=this.getUniform("uTransitionSize"),this.color=this.getUniform("color")}}class Z extends Y{fillCode(){super.fillCode(),this.fragmentShaderCode="precision highp float;\nuniform vec2 uCameraRange;\nuniform vec2 uInvViewportSize;\nuniform float uTransitionSize;\nfloat calc_depth(in float z)\n{\n  return (2.0 * uCameraRange.x) / (uCameraRange.y + uCameraRange.x - z*(uCameraRange.y - uCameraRange.x));\n}\nuniform sampler2D sDepth;\nvarying vec2 vTextureCoord;\nuniform sampler2D sTexture;\nuniform vec4 color;\n\nvoid main() {\n   vec4 mask = vec4(texture2D(sTexture, vTextureCoord).rrr, 1.0);\n   vec4 diffuse = mask * color;\n   vec2 coords = gl_FragCoord.xy * uInvViewportSize;\n   float geometryZ = calc_depth(texture2D(sDepth, coords).r);\n   float sceneZ = calc_depth(gl_FragCoord.z);\n   float a = clamp(geometryZ - sceneZ, 0.0, 1.0);\n   float b = smoothstep(0.0, uTransitionSize, a);\n   b = b * mask.r * color.w;\n   gl_FragColor = vec4(diffuse.rgb * b, b);\n}"}fillUniformsAttributes(){this.view_proj_matrix=this.getUniform("view_proj_matrix"),this.rm_Vertex=this.getAttrib("rm_Vertex"),this.rm_TexCoord0=this.getAttrib("rm_TexCoord0"),this.sTexture=this.getUniform("sTexture"),this.cameraRange=this.getUniform("uCameraRange"),this.sDepth=this.getUniform("sDepth"),this.invViewportSize=this.getUniform("uInvViewportSize"),this.transitionSize=this.getUniform("uTransitionSize"),this.color=this.getUniform("color")}}class q extends z{fillCode(){super.fillCode(),this.fragmentShaderCode="#version 300 es\nprecision mediump float;\nin vec2 vTextureCoord;\nuniform sampler2D sTexture;\nuniform vec4 uColor;\nout vec4 fragColor;\n\nvoid main() {\n  fragColor = uColor * texture(sTexture, vTextureCoord);\n}"}fillUniformsAttributes(){super.fillUniformsAttributes(),this.uColor=this.getUniform("uColor")}}class Q extends B{fillCode(){super.fillCode(),this.vertexShaderCode="uniform mat4 view_proj_matrix;\n            attribute vec4 rm_Vertex;\n            attribute vec2 rm_TexCoord0;\n            varying vec2 vTextureCoord;\n            varying vec2 vTextureCoordDisplacement;\n            uniform float uTime;\n            \n            void main() {\n                gl_Position = view_proj_matrix * rm_Vertex;\n                vTextureCoord = rm_TexCoord0;\n                // vTextureCoordDisplacement = rm_TexCoord0 * 0.35 + vec2(uTime, uTime);\n                vTextureCoordDisplacement = rm_TexCoord0 + vec2(uTime, uTime);\n            }",this.fragmentShaderCode="precision mediump float;\n            varying vec2 vTextureCoord;\n            varying vec2 vTextureCoordDisplacement;\n            uniform sampler2D sTexture;\n            uniform sampler2D sDisplacement;\n            uniform vec4 color;\n            uniform float uLightning;\n            uniform vec4 uLightningExponent;\n\n            void main() {\n                vec2 offset = texture2D(sDisplacement, vTextureCoordDisplacement).xz * 0.025;\n                vec2 texCoord = vTextureCoord + offset;\n                vec4 grayscale = vec4(texture2D(sTexture, texCoord).rrr, 1.0);\n                grayscale += pow(grayscale, uLightningExponent) * uLightning;\n                gl_FragColor = grayscale * color;\n            }"}fillUniformsAttributes(){super.fillUniformsAttributes(),this.sDisplacement=this.getUniform("sDisplacement"),this.uTime=this.getUniform("uTime"),this.uLightning=this.getUniform("uLightning"),this.uLightningExponent=this.getUniform("uLightningExponent")}drawModel(t,e,i,r,s,o,n,a,h,l,d){if(void 0===this.rm_Vertex||void 0===this.view_proj_matrix||void 0===this.color)return;t.gl.uniform4f(this.color,this._color[0],this._color[1],this._color[2],this._color[3]),super.drawModel(t,e,i,r,s,o,n,a,h,l,d)}}class J extends C{fillCode(){super.fillCode(),this.fragmentShaderCode="precision mediump float;\n            varying vec2 vTextureCoord;\n            uniform sampler2D sTexture;\n\n            void main() {\n                float color = texture2D(sTexture, vTextureCoord).r;\n                gl_FragColor = vec4(color, color, color, 1.0);\n            }"}}class tt extends s{fillCode(){this.vertexShaderCode="#version 300 es\nprecision highp float;\nuniform sampler2D sPositions;\n// x = texture width; y = texel half width; z = sampler y coord (animation frame); w = chunk size\nuniform vec4 uTexelSizes;\nuniform float uTexelHeight;\nuniform int uTextureWidthInt;\nuniform mat4 view_proj_matrix;\n\nfloat getCenter(float y) {\n  return y - mod(y, uTexelHeight) + uTexelHeight * 0.5;\n}\n\nvec4 linearFilter(vec2 coords) {\n  vec2 coords1 = vec2(coords.x, coords.y - uTexelHeight * 0.49);\n  vec2 coords2 = vec2(coords.x, coords.y + uTexelHeight * 0.49);\n  float center1 = getCenter(coords1.y);\n  float center2 = getCenter(coords2.y);\n  vec4 v1 = texture(sPositions, vec2(coords1.x, center1));\n  vec4 v2 = texture(sPositions, vec2(coords2.x, center2));\n  float d1 = abs(coords.y - center1);\n  float d2 = abs(coords.y - center2);\n  if (d1 > d2) {\n    return mix( v1, v2, d1 / (uTexelHeight) );\n  } else {\n    return mix( v2, v1, d2 / (uTexelHeight) );\n  }\n}\n\nvoid main() {\n  float id = float(gl_VertexID % uTextureWidthInt);  float chunk = float(gl_VertexID / uTextureWidthInt);  vec2 coords = vec2(id / uTexelSizes.x + uTexelSizes.y, uTexelSizes.z);  coords.y += chunk * uTexelSizes.w;  vec4 position = linearFilter(coords);  gl_Position = view_proj_matrix * position;\n}",this.fragmentShaderCode="#version 300 es\nprecision mediump float;\nout vec4 fragColor;\n\nvoid main() {\n  fragColor = vec4(0.0, 1.0, 0.0, 1.0);\n}"}fillUniformsAttributes(){this.view_proj_matrix=this.getUniform("view_proj_matrix"),this.uTextureWidthInt=this.getUniform("uTextureWidthInt"),this.uTexelHeight=this.getUniform("uTexelHeight"),this.sPositions=this.getUniform("sPositions"),this.uTexelSizes=this.getUniform("uTexelSizes")}drawModel(t,e,i,r,s,o,n,a,h,l,d){if(void 0===this.view_proj_matrix)return;const u=t.gl;e.bindBuffers(u),t.calculateMVPMatrix(i,r,s,o,n,a,h,l,d),u.uniformMatrix4fv(this.view_proj_matrix,!1,t.getMVPMatrix()),u.drawElements(u.TRIANGLES,3*e.getNumIndices(),u.UNSIGNED_SHORT,0),t.checkGlError("DiffuseShader glDrawElements")}}const et=[[0,0,0],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0],[0,1.2,0],[0,-1.2,0],[1.2,0,0],[-1.2,0,0],[0,-6,0],[2,-5,0],[-2,-5,0]];class it extends class{constructor(){this.mMMatrix=n(),this.mVMatrix=n(),this.mMVPMatrix=n(),this.mProjMatrix=n(),this.matOrtho=n(),this.m_boundTick=this.tick.bind(this),this.isWebGL2=!1,this.viewportWidth=0,this.viewportHeight=0}get gl(){if(void 0===this.m_gl)throw new Error("No WebGL context");return this.m_gl}logGLError(){var t=this.gl.getError();t!==this.gl.NO_ERROR&&console.warn(`WebGL error # + ${t}`)}setTexture2D(t,e,i){this.gl.activeTexture(this.gl.TEXTURE0+t),this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.gl.uniform1i(i,t)}setTextureCubemap(t,e,i){this.gl.activeTexture(this.gl.TEXTURE0+t),this.gl.bindTexture(this.gl.TEXTURE_CUBE_MAP,e),this.gl.uniform1i(i,t)}setFOV(t,e,i,r,s){const o=Math.tan(e/360*Math.PI)*r,n=o*i;!function(t,e,i,r,s,o,n){var a=1/(i-e),h=1/(s-r),l=1/(o-n);t[0]=2*o*a,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=2*o*h,t[6]=0,t[7]=0,t[8]=(i+e)*a,t[9]=(s+r)*h,t[10]=(n+o)*l,t[11]=-1,t[12]=0,t[13]=0,t[14]=n*o*2*l,t[15]=0}(t,-n,n,-o,o,r,s)}calculateMVPMatrix(t,e,i,r,s,o,n,h,l){!function(t){t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1}(this.mMMatrix),function(t,e,i,r){var s,o,n,a,h,l,d,u,m,c,g,f,T,x,E,_,A,p,v,S,R,C,y,M,w=r[0],D=r[1],P=r[2],F=Math.hypot(w,D,P);F<1e-6||(w*=F=1/F,D*=F,P*=F,s=Math.sin(i),n=1-(o=Math.cos(i)),a=e[0],h=e[1],l=e[2],d=e[3],u=e[4],m=e[5],c=e[6],g=e[7],f=e[8],T=e[9],x=e[10],E=e[11],_=w*w*n+o,A=D*w*n+P*s,p=P*w*n-D*s,v=w*D*n-P*s,S=D*D*n+o,R=P*D*n+w*s,C=w*P*n+D*s,y=D*P*n-w*s,M=P*P*n+o,t[0]=a*_+u*A+f*p,t[1]=h*_+m*A+T*p,t[2]=l*_+c*A+x*p,t[3]=d*_+g*A+E*p,t[4]=a*v+u*S+f*R,t[5]=h*v+m*S+T*R,t[6]=l*v+c*S+x*R,t[7]=d*v+g*S+E*R,t[8]=a*C+u*y+f*M,t[9]=h*C+m*y+T*M,t[10]=l*C+c*y+x*M,t[11]=d*C+g*y+E*M,e!==t&&(t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]))}(this.mMMatrix,this.mMMatrix,0,[1,0,0]),function(t,e,i){var r,s,o,n,a,h,l,d,u,m,c,g,f=i[0],T=i[1],x=i[2];e===t?(t[12]=e[0]*f+e[4]*T+e[8]*x+e[12],t[13]=e[1]*f+e[5]*T+e[9]*x+e[13],t[14]=e[2]*f+e[6]*T+e[10]*x+e[14],t[15]=e[3]*f+e[7]*T+e[11]*x+e[15]):(r=e[0],s=e[1],o=e[2],n=e[3],a=e[4],h=e[5],l=e[6],d=e[7],u=e[8],m=e[9],c=e[10],g=e[11],t[0]=r,t[1]=s,t[2]=o,t[3]=n,t[4]=a,t[5]=h,t[6]=l,t[7]=d,t[8]=u,t[9]=m,t[10]=c,t[11]=g,t[12]=r*f+a*T+u*x+e[12],t[13]=s*f+h*T+m*x+e[13],t[14]=o*f+l*T+c*x+e[14],t[15]=n*f+d*T+g*x+e[15])}(this.mMMatrix,this.mMMatrix,[t,e,i]),function(t,e,i){var r=i[0],s=i[1],o=i[2];t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t[4]=e[4]*s,t[5]=e[5]*s,t[6]=e[6]*s,t[7]=e[7]*s,t[8]=e[8]*o,t[9]=e[9]*o,t[10]=e[10]*o,t[11]=e[11]*o,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]}(this.mMMatrix,this.mMMatrix,[n,h,l]),function(t,e,i){var r=Math.sin(i),s=Math.cos(i),o=e[4],n=e[5],a=e[6],h=e[7],l=e[8],d=e[9],u=e[10],m=e[11];e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=o*s+l*r,t[5]=n*s+d*r,t[6]=a*s+u*r,t[7]=h*s+m*r,t[8]=l*s-o*r,t[9]=d*s-n*r,t[10]=u*s-a*r,t[11]=m*s-h*r}(this.mMMatrix,this.mMMatrix,r),function(t,e,i){var r=Math.sin(i),s=Math.cos(i),o=e[0],n=e[1],a=e[2],h=e[3],l=e[8],d=e[9],u=e[10],m=e[11];e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=o*s-l*r,t[1]=n*s-d*r,t[2]=a*s-u*r,t[3]=h*s-m*r,t[8]=o*r+l*s,t[9]=n*r+d*s,t[10]=a*r+u*s,t[11]=h*r+m*s}(this.mMMatrix,this.mMMatrix,s),function(t,e,i){var r=Math.sin(i),s=Math.cos(i),o=e[0],n=e[1],a=e[2],h=e[3],l=e[4],d=e[5],u=e[6],m=e[7];e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=o*s+l*r,t[1]=n*s+d*r,t[2]=a*s+u*r,t[3]=h*s+m*r,t[4]=l*s-o*r,t[5]=d*s-n*r,t[6]=u*s-a*r,t[7]=m*s-h*r}(this.mMMatrix,this.mMMatrix,o),a(this.mMVPMatrix,this.mVMatrix,this.mMMatrix),a(this.mMVPMatrix,this.mProjMatrix,this.mMVPMatrix)}drawScene(){this.gl.viewport(0,0,this.gl.canvas.width,this.gl.canvas.height),this.gl.clearColor(0,0,0,1),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT)}tick(){requestAnimationFrame(this.m_boundTick),this.resizeCanvas(),this.drawScene(),this.animate()}initGL(t){const e=t.getContext("webgl",{alpha:!1});if(null===e)throw new Error("Cannot initialize WebGL context");return e}initGL2(t){let e=t.getContext("webgl2",{alpha:!1});return null===e?(console.warn("Could not initialise WebGL 2, falling back to WebGL 1"),this.initGL(t)):e}init(t,e=!1){if(this.onBeforeInit(),this.canvas=document.getElementById(t),null===this.canvas)throw new Error("Cannot find canvas element");this.viewportWidth=this.canvas.width,this.viewportHeight=this.canvas.height,this.m_gl=e?this.initGL2(this.canvas):this.initGL(this.canvas),this.m_gl?(this.resizeCanvas(),this.onAfterInit(),this.initShaders(),this.loadData(),this.m_boundTick()):this.onInitError()}resizeCanvas(){if(void 0===this.canvas)return;const t=window.devicePixelRatio||1,e=Math.floor(this.canvas.clientWidth*t),i=Math.floor(this.canvas.clientHeight*t);this.canvas.width==e&&this.canvas.height==i||(this.canvas.width=e,this.canvas.height=i)}checkGlError(t){let e;for(;(e=this.gl.getError())!==this.gl.NO_ERROR;)console.error(`${t}: glError ${e}`)}unbindBuffers(){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,null)}getMVPMatrix(){return this.mMVPMatrix}getOrthoMatrix(){return this.matOrtho}getModelMatrix(){return this.mMMatrix}getViewMatrix(){return this.mVMatrix}}{constructor(){super(),this.lastTime=0,this.angleYaw=0,this.loaded=!1,this.fmSky=new r,this.fmStripe=new r,this.fmDust=new r,this.fmBody=new r,this.fmScythe=new r,this.fmCloth=new r,this.fmEyes=new r,this.fmSmoke=new r,this.Z_NEAR=1,this.Z_FAR=110,this.timerDustRotation=0,this.DUST_ROTATION_SPEED=18003333,this.timerDustFlickering=0,this.DUST_FLICKERING_SPEED=2100,this.timerCharacterAnimation=0,this.REAPER_ANIMATION_PERIOD=5e3,this.timerSkyAnimation=0,this.SKY_ANIMATION_PERIOD=9e4,this.timerSmokeMovement=0,this.SMOKE_MOVEMENT_PERIOD=8e3,this.timerSmokeRotation=0,this.SMOKE_ROTATION_PERIOD=903333,this.timerSkyRotation=0,this.SKY_ROTATION_PERIOD=350333,this.timerGhostsRotation=0,this.GHOSTS_ROTATION_PERIOD=4200,this.timerGhostsRotation2=0,this.GHOSTS_ROTATION_PERIOD2=4100,this.timerEyes=0,this.EYES_PERIOD=2500,this.timerLightning=0,this.LIGHTNING_PERIOD=3500,this.SMOKE_SOFTNESS=.01,this.SMOKE_SCALE=.09,this.SMOKE_TRAVEL_Z=16,this.ANIMATION_TEXTURE_WIDTH=1e3,this.REAPER_ANIMATION_TEXTURE_WIDTH=512,this.animationsBody={idle1:new W(this.REAPER_ANIMATION_TEXTURE_WIDTH,2535,51),idle2:new W(this.REAPER_ANIMATION_TEXTURE_WIDTH,2535,51),fly:new W(this.REAPER_ANIMATION_TEXTURE_WIDTH,2535,21),"fly-fast":new W(this.REAPER_ANIMATION_TEXTURE_WIDTH,2535,16)},this.animationsScythe={idle1:new W(608,608,51),idle2:new W(608,608,51),fly:new W(608,608,21),"fly-fast":new W(608,608,16)},this.animationsEyes={idle1:new W(36,36,51),idle2:new W(36,36,51),fly:new W(36,36,21),"fly-fast":new W(36,36,16)},this.animationsCloth={idle1:new W(664,664,51),idle2:new W(664,664,51),fly:new W(664,664,21),"fly-fast":new W(664,664,16)},this.currentAnimation="idle1",this.cameraMode=k.Random,this.currentRandomCamera=0,this.matViewInverted=w(),this.matViewInvertedTransposed=w(),this.matTemp=w(),this.cameraPosition=N(),this.cameraRotation=N(),this.CAMERAS=[{start:{position:new Float32Array([20.63134765625,.04024043679237366,-23.309953689575195]),rotation:new Float32Array([-1.037999153137207,4.560023307800293,0])},end:{position:new Float32Array([20.027006149291992,5.342957019805908,30.2779598236084]),rotation:new Float32Array([.6720000505447388,4.404022216796875,0])},speedMultiplier:1},{start:{position:new Float32Array([-6.6900529861450195,4.612008094787598,50.24580383300781]),rotation:new Float32Array([1.3187947273254395,2.190007209777832,0])},end:{position:new Float32Array([-32.61750030517578,24.84134292602539,4.696905612945557]),rotation:new Float32Array([-.23520641028881073,2.2440075874328613,0])},speedMultiplier:1},{start:{position:new Float32Array([32.16560745239258,-19.801870346069336,10.339131355285645]),rotation:new Float32Array([.012000114656984806,-1,0])},end:{position:new Float32Array([-31.443674087524414,-25.470523834228516,33.82668685913086]),rotation:new Float32Array([.5040005445480347,.9528526067733765,0])},speedMultiplier:1},{start:{position:new Float32Array([34.4621467590332,25.997318267822266,16.80156135559082]),rotation:new Float32Array([.17399989068508148,4.0560197830200195,0])},end:{position:new Float32Array([-32.87525177001953,22.77642250061035,20.858415603637695]),rotation:new Float32Array([.21599987149238586,2.2020068168640137,0])},speedMultiplier:1},{start:{position:new Float32Array([-13.161895751953125,6.17222785949707,27.73927879333496]),rotation:new Float32Array([.5700000524520874,2.0220019817352295,0])},end:{position:new Float32Array([-17.9815673828125,4.7135090827941895,-.5088852643966675]),rotation:new Float32Array([-.5280001759529114,1.8480011224746704,0])},speedMultiplier:1},{start:{position:new Float32Array([16.19297218322754,-4.055665493011475,25.375]),rotation:new Float32Array([.5220006108283997,4.746006488800049,0])},end:{position:new Float32Array([13.601936340332031,14.41900634765625,1.7308120727539062]),rotation:new Float32Array([-.47400006651878357,3.803999900817871,0])},speedMultiplier:1},{start:{position:new Float32Array([-8.11626148223877,6.703431129455566,27.8272705078125]),rotation:new Float32Array([.5640001893043518,2.082002878189087,0])},end:{position:new Float32Array([-15.641282081604004,10.945764541625977,9.242594718933105]),rotation:new Float32Array([-.2639997899532318,2.0340025424957275,0])},speedMultiplier:1},{start:{position:new Float32Array([-6.933125972747803,12.842277526855469,17.02661895751953]),rotation:new Float32Array([-.04200000315904617,2.8091883659362793,.3])},end:{position:new Float32Array([6.7748637199401855,14.75560474395752,7.144927024841309]),rotation:new Float32Array([-.39600011706352234,3.5771920680999756,0])},speedMultiplier:1},{start:{position:new Float32Array([-.5569624304771423,8.056137084960938,13.825691223144531]),rotation:new Float32Array([-.6540009379386902,2.7420051097869873,.1])},end:{position:new Float32Array([-.5569624304771423,8.056137084960938,13.825691223144531]),rotation:new Float32Array([-.07200095057487488,3.1740081310272217,0])},speedMultiplier:1},{start:{position:new Float32Array([7.284486293792725,12.943374633789062,15.877676963806152]),rotation:new Float32Array([.04800054058432579,3.660011053085327,0])},end:{position:new Float32Array([-6.318485736846924,13.09317684173584,10.776239395141602]),rotation:new Float32Array([-.16799943149089813,2.6160080432891846,0])},speedMultiplier:1},{start:{position:new Float32Array([29.924358367919922,-20.450387954711914,2.7626044750213623]),rotation:new Float32Array([-.19199976325035095,5.320858955383301,0])},end:{position:new Float32Array([11.117116928100586,20.80797004699707,33.48508834838867]),rotation:new Float32Array([.708000123500824,3.538848400115967,0])},speedMultiplier:1},{start:{position:new Float32Array([5.5241804122924805,11.871227264404297,12.655675888061523]),rotation:new Float32Array([-.26999998092651367,3.264004707336426,0])},end:{position:new Float32Array([-7.568962574005127,10.686423301696777,15.796873092651367]),rotation:new Float32Array([.0599999763071537,2.393998622894287,0])},speedMultiplier:1},{start:{position:new Float32Array([-2.939835786819458,9.555854797363281,12.755476951599121]),rotation:new Float32Array([-.35400035977363586,2.7383251190185547,0])},end:{position:new Float32Array([-15.307744026184082,38.544288635253906,1.1079256534576416]),rotation:new Float32Array([-.35400035977363586,2.7383251190185547,0])},speedMultiplier:1},{start:{position:new Float32Array([8.92319107055664,17.87936019897461,20.506385803222656]),rotation:new Float32Array([.2940000295639038,3.4799962043762207,0])},end:{position:new Float32Array([22.2241268157959,-3.5090885162353516,8.84290885925293]),rotation:new Float32Array([-.14999999105930328,4.853999614715576,0])},speedMultiplier:1},{start:{position:new Float32Array([-12.525442123413086,13.192499160766602,23.48917007446289]),rotation:new Float32Array([.4800003468990326,2.070006847381592,0])},end:{position:new Float32Array([-20.888025283813477,-13.184157371520996,6.709957122802734]),rotation:new Float32Array([-.1259997934103012,1.068004846572876,0])},speedMultiplier:1},{start:{position:new Float32Array([-1.4070744514465332,10.23020076751709,21.719236373901367]),rotation:new Float32Array([.7260005474090576,3.0300018787384033,0])},end:{position:new Float32Array([-2.625640869140625,21.179767608642578,-2.4872467517852783]),rotation:new Float32Array([-.5999994874000549,3.0300018787384033,0])},speedMultiplier:1},{start:{position:new Float32Array([13.535038948059082,7.506402015686035,24.7524356842041]),rotation:new Float32Array([.40200015902519226,3.7320029735565186,0])},end:{position:new Float32Array([-8.367344856262207,15.256627082824707,9.666288375854492]),rotation:new Float32Array([-.34200000762939453,2.724001407623291,0])},speedMultiplier:1}],this.CAMERA_SPEED=.01,this.CAMERA_MIN_DURATION=8e3,this.cameraPositionInterpolator=new V,this.SCALE=10,this.dustSpriteSize=0,this.DUST_COLOR={r:10/256,g:10/256,b:10/256,a:1},this.DUST_SPRITE_SIZE=.006,this.DUST_SCALE=.16,this.lightningDirection=N(),this.PRESETS=[{bodySuffix:"green",clothSuffix:"green",colorEyes:{r:.1,g:.8,b:.1,a:1},colorSky:{r:.38,g:.6,b:.4,a:1},colorSmoke:{r:.2,g:.5,b:.25,a:.35}},{bodySuffix:"red",clothSuffix:"red",colorEyes:{r:.6,g:.1,b:.1,a:1},colorSky:{r:.65,g:.35,b:.32,a:1},colorSmoke:{r:.17,g:.22,b:.25,a:.8}},{bodySuffix:"white",clothSuffix:"blue",colorEyes:{r:.13,g:.13,b:.9,a:1},colorSky:{r:.51,g:.72,b:.9,a:1},colorSmoke:{r:.8,g:.9,b:.99,a:.25}},{bodySuffix:"brown",clothSuffix:"yellow",colorEyes:{r:.7,g:.6,b:.4,a:1},colorSky:{r:.95,g:.9,b:.53,a:1},colorSmoke:{r:.6,g:.6,b:.2,a:.3}},{bodySuffix:"brown",clothSuffix:"brown",colorEyes:{r:.7,g:.6,b:.4,a:1},colorSky:{r:.72,g:.7,b:.43,a:1},colorSmoke:{r:.17,g:.22,b:.25,a:.8}}],this.PRESET=this.PRESETS[4],this.useLightning=!0,this.cameraPositionInterpolator.speed=this.CAMERA_SPEED,this.cameraPositionInterpolator.minDuration=this.CAMERA_MIN_DURATION,this.randomizeCamera(),document.addEventListener("keypress",(t=>{"1"===t.key?(this.CAMERAS[0].start={position:new Float32Array([this.cameraPosition[0],this.cameraPosition[1],this.cameraPosition[2]]),rotation:new Float32Array([this.cameraRotation[0],this.cameraRotation[1],this.cameraRotation[2]])},this.logCamera()):"2"===t.key&&(this.CAMERAS[0].end={position:new Float32Array([this.cameraPosition[0],this.cameraPosition[1],this.cameraPosition[2]]),rotation:new Float32Array([this.cameraRotation[0],this.cameraRotation[1],this.cameraRotation[2]])},this.logCamera())})),this.randomizeLightning()}set lightning(t){this.useLightning=t}logCamera(){const t=this.CAMERAS[0];console.log(`\n        {\n            start: {\n                position: new Float32Array([${t.start.position.toString()}]),\n                rotation: new Float32Array([${t.start.rotation.toString()}])\n            },\n            end: {\n                position: new Float32Array([${t.end.position.toString()}]),\n                rotation: new Float32Array([${t.end.rotation.toString()}])\n            },\n            speedMultiplier: 1.0\n        },\n        `)}setCustomCamera(t,e,i){this.customCamera=t,void 0!==e&&(this.cameraPosition=e),void 0!==i&&(this.cameraRotation=i)}resetCustomCamera(){this.customCamera=void 0}onBeforeInit(){}onAfterInit(){}onInitError(){var t,e;null===(t=document.getElementById("canvasGL"))||void 0===t||t.classList.add("hidden"),null===(e=document.getElementById("alertError"))||void 0===e||e.classList.remove("hidden")}initShaders(){this.shaderDiffuse=new C(this.gl),this.shaderDiffuseAnimatedTexture=new X(this.gl),this.shaderDiffuseAnimatedTextureChunked=new z(this.gl),this.shaderDiffuseAnimatedTextureChunkedColored=new q(this.gl),this.shaderAtAnimatedTextureChunked=new K(this.gl),this.shaderLitAnimatedTextureChunked=new $(this.gl),this.shaderDiffuseAlpha=new G(this.gl),this.shaderDiffuseColored=new B(this.gl),this.shaderDiffuseOneChannel=new J(this.gl),this.shaderBend=new H(this.gl),this.shaderPointSpriteColored=new j(this.gl),this.shaderSoftDiffuseColored=new Y(this.gl),this.shaderSoftDiffuseColoredAlpha=new Z(this.gl),this.shaderSky=new Q(this.gl),this.shaderDepthAnimated=new tt(this.gl)}async loadFloatingPointTexture(t,e,i,r,s=e.LINEAR,o=e.LINEAR,n=!1,a="fp16"){const h=e.createTexture();if(null===h)throw new Error("Error creating WebGL texture");const l=await fetch(t),d=await l.arrayBuffer(),u="fp16"===a?new Uint16Array(d):new Int8Array(d);return e.bindTexture(e.TEXTURE_2D,h),this.checkGlError("loadFloatingPointTexture 0"),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.texImage2D(e.TEXTURE_2D,0,"fp16"===a?e.RGB16F:e.RGB8_SNORM,i,r,0,e.RGB,"fp16"===a?e.HALF_FLOAT:e.BYTE,u),this.checkGlError("loadFloatingPointTexture 1"),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,s),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,o),!0===n?(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE)):(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT)),this.checkGlError("loadFloatingPointTexture 2"),e.bindTexture(e.TEXTURE_2D,null),console.log(`Loaded texture ${t} [${i}x${r}]`),h}async loadData(){var t,e;await Promise.all([this.fmSky.load("data/models/sky",this.gl),this.fmStripe.load("data/models/stripe-optimized-1",this.gl),this.fmDust.load("data/models/particles_20",this.gl),this.fmBody.load("data/models/body",this.gl),this.fmScythe.load("data/models/scythe",this.gl),this.fmCloth.load("data/models/cloth",this.gl),this.fmEyes.load("data/models/eyes",this.gl),this.fmSmoke.load("data/models/smoke100",this.gl)]),[this.textureSky,this.textureParticle,this.textureDisplacement,this.textureDust,this.textureBody,this.textureCloth,this.textureBodyAnim,this.textureBodyNormalsAnim,this.textureScytheAnim,this.textureScytheNormalsAnim,this.textureClothAnim,this.textureEyesAnim,this.textureEyes,this.textureSmoke,this.textureVignette]=await Promise.all([i.load("data/textures/sky.webp",this.gl,void 0,void 0,!1),i.load("data/textures/particle1.webp",this.gl,void 0,void 0,!1),i.load("data/textures/displacement.webp",this.gl,void 0,void 0,!1),i.load("data/textures/dust.webp",this.gl,this.gl.LINEAR,this.gl.LINEAR,!1),i.load(`data/textures/body-${this.PRESET.bodySuffix}.webp`,this.gl,this.gl.LINEAR,this.gl.LINEAR,!1),i.load(`data/textures/cloth-${this.PRESET.clothSuffix}.webp`,this.gl,this.gl.LINEAR,this.gl.LINEAR,!1),this.loadFloatingPointTexture(`data/textures/anims/${this.currentAnimation}/body-positions.rgb.fp16`,this.gl,this.animationsBody[this.currentAnimation].textureWidth,this.animationsBody[this.currentAnimation].textureHeight,this.gl.NEAREST,this.gl.NEAREST,!0),this.loadFloatingPointTexture(`data/textures/anims/${this.currentAnimation}/body-normals.rgb.s8`,this.gl,this.animationsBody[this.currentAnimation].textureWidth,this.animationsBody[this.currentAnimation].textureHeight,this.gl.NEAREST,this.gl.NEAREST,!0,"snorm8"),this.loadFloatingPointTexture(`data/textures/anims/${this.currentAnimation}/scythe-positions.rgb.fp16`,this.gl,this.animationsScythe[this.currentAnimation].textureWidth,this.animationsScythe[this.currentAnimation].textureHeight,this.gl.NEAREST,this.gl.NEAREST,!0),this.loadFloatingPointTexture(`data/textures/anims/${this.currentAnimation}/scythe-normals.rgb.s8`,this.gl,this.animationsScythe[this.currentAnimation].textureWidth,this.animationsScythe[this.currentAnimation].textureHeight,this.gl.NEAREST,this.gl.NEAREST,!0,"snorm8"),this.loadFloatingPointTexture(`data/textures/anims/${this.currentAnimation}/cloth-positions.rgb.fp16`,this.gl,this.animationsCloth[this.currentAnimation].textureWidth,this.animationsCloth[this.currentAnimation].textureHeight,this.gl.NEAREST,this.gl.NEAREST,!0),this.loadFloatingPointTexture(`data/textures/anims/${this.currentAnimation}/eyes.rgb.fp16`,this.gl,this.animationsEyes[this.currentAnimation].textureWidth,this.animationsEyes[this.currentAnimation].textureHeight,this.gl.NEAREST,this.gl.NEAREST,!0),await i.load("data/textures/eye_alpha.webp",this.gl),await i.load("data/textures/smoke.webp",this.gl),await i.load("data/textures/vignette.webp",this.gl)]),this.initOffscreen(),this.initVignette(),this.loaded=!0,console.log("Loaded all assets"),null===(t=document.getElementById("message"))||void 0===t||t.classList.add("hidden"),null===(e=document.getElementById("canvasGL"))||void 0===e||e.classList.remove("transparent"),setTimeout((()=>{var t;return null===(t=document.querySelector(".promo"))||void 0===t?void 0:t.classList.remove("transparent")}),1800),setTimeout((()=>{var t;return null===(t=document.querySelector("#toggleFullscreen"))||void 0===t?void 0:t.classList.remove("transparent")}),1800)}initOffscreen(){void 0!==this.canvas&&(this.textureOffscreenColor=R.createNpotTexture(this.gl,this.canvas.width,this.canvas.height,!1),this.textureOffscreenDepth=R.createDepthTexture(this.gl,this.canvas.width,this.canvas.height),this.fboOffscreen=new S(this.gl),this.fboOffscreen.textureHandle=this.textureOffscreenColor,this.fboOffscreen.depthTextureHandle=this.textureOffscreenDepth,this.fboOffscreen.width=this.canvas.width,this.fboOffscreen.height=this.canvas.height,this.fboOffscreen.createGLData(this.canvas.width,this.canvas.height),this.checkGlError("offscreen FBO"),console.log("Initialized offscreen FBO."))}checkGlError(t){}initVignette(){O(this.matOrtho,-1,1,-1,1,2,250),this.mQuadTriangles=new Float32Array([-1,-1,-5,0,0,1,-1,-5,1,0,-1,1,-5,0,1,1,1,-5,1,1]),this.mTriangleVerticesVignette=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.mTriangleVerticesVignette),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.mQuadTriangles,this.gl.STATIC_DRAW)}async changeScene(){"idle1"===this.currentAnimation?this.currentAnimation="idle2":"idle2"===this.currentAnimation?this.currentAnimation="fly":"fly"===this.currentAnimation?this.currentAnimation="fly-fast":"fly-fast"===this.currentAnimation&&(this.currentAnimation="idle1"),[this.textureBodyAnim,this.textureBodyNormalsAnim,this.textureScytheAnim,this.textureScytheNormalsAnim,this.textureClothAnim,this.textureEyesAnim]=await Promise.all([this.loadFloatingPointTexture(`data/textures/anims/${this.currentAnimation}/body-positions.rgb.fp16`,this.gl,this.animationsBody[this.currentAnimation].textureWidth,this.animationsBody[this.currentAnimation].textureHeight,this.gl.NEAREST,this.gl.NEAREST,!0,"fp16"),this.loadFloatingPointTexture(`data/textures/anims/${this.currentAnimation}/body-normals.rgb.s8`,this.gl,this.animationsBody[this.currentAnimation].textureWidth,this.animationsBody[this.currentAnimation].textureHeight,this.gl.NEAREST,this.gl.NEAREST,!0,"snorm8"),this.loadFloatingPointTexture(`data/textures/anims/${this.currentAnimation}/scythe-positions.rgb.fp16`,this.gl,this.animationsScythe[this.currentAnimation].textureWidth,this.animationsScythe[this.currentAnimation].textureHeight,this.gl.NEAREST,this.gl.NEAREST,!0,"fp16"),this.loadFloatingPointTexture(`data/textures/anims/${this.currentAnimation}/scythe-normals.rgb.s8`,this.gl,this.animationsScythe[this.currentAnimation].textureWidth,this.animationsScythe[this.currentAnimation].textureHeight,this.gl.NEAREST,this.gl.NEAREST,!0,"snorm8"),this.loadFloatingPointTexture(`data/textures/anims/${this.currentAnimation}/cloth-positions.rgb.fp16`,this.gl,this.animationsCloth[this.currentAnimation].textureWidth,this.animationsCloth[this.currentAnimation].textureHeight,this.gl.NEAREST,this.gl.NEAREST,!0),this.loadFloatingPointTexture(`data/textures/anims/${this.currentAnimation}/eyes.rgb.fp16`,this.gl,this.animationsEyes[this.currentAnimation].textureWidth,this.animationsEyes[this.currentAnimation].textureHeight,this.gl.NEAREST,this.gl.NEAREST,!0)])}animate(){const t=(new Date).getTime();if(0!=this.lastTime){const e=t-this.lastTime;this.angleYaw+=e/200,this.angleYaw%=360,this.timerDustRotation=t%this.DUST_ROTATION_SPEED/this.DUST_ROTATION_SPEED,this.timerDustFlickering=t%this.DUST_FLICKERING_SPEED/this.DUST_FLICKERING_SPEED;const i=this.timerLightning;this.timerCharacterAnimation=t%this.REAPER_ANIMATION_PERIOD/this.REAPER_ANIMATION_PERIOD,this.timerSkyAnimation=t%this.SKY_ANIMATION_PERIOD/this.SKY_ANIMATION_PERIOD,this.timerSmokeMovement=t%this.SMOKE_MOVEMENT_PERIOD/this.SMOKE_MOVEMENT_PERIOD,this.timerSmokeRotation=t%this.SMOKE_ROTATION_PERIOD/this.SMOKE_ROTATION_PERIOD,this.timerSkyRotation=t%this.SKY_ROTATION_PERIOD/this.SKY_ROTATION_PERIOD,this.timerGhostsRotation=t%this.GHOSTS_ROTATION_PERIOD/this.GHOSTS_ROTATION_PERIOD,this.timerGhostsRotation2=t%this.GHOSTS_ROTATION_PERIOD2/this.GHOSTS_ROTATION_PERIOD2,this.timerEyes=t%this.EYES_PERIOD/this.EYES_PERIOD,this.useLightning&&(this.timerLightning=t%this.LIGHTNING_PERIOD/this.LIGHTNING_PERIOD),this.cameraPositionInterpolator.iterate(t),1===this.cameraPositionInterpolator.timer&&this.randomizeCamera(),this.timerLightning<i&&this.randomizeLightning()}this.lastTime=t}setCameraFOV(t){var e;e=this.gl.canvas.height>0?this.gl.canvas.width/this.gl.canvas.height:1;let i=0;i=this.gl.canvas.width>=this.gl.canvas.height?60*t:80*t,this.setFOV(this.mProjMatrix,i,e,this.Z_NEAR,this.Z_FAR),this.dustSpriteSize=Math.min(this.gl.canvas.height,this.gl.canvas.width)*this.DUST_SPRITE_SIZE}positionCamera(t){if(void 0===this.customCamera)if(this.cameraMode===k.Random)this.mVMatrix=this.cameraPositionInterpolator.matrix,this.cameraPosition[0]=this.cameraPositionInterpolator.cameraPosition[0],this.cameraPosition[1]=this.cameraPositionInterpolator.cameraPosition[1],this.cameraPosition[2]=this.cameraPositionInterpolator.cameraPosition[2];else{const t=this.angleYaw/360*Math.PI*2,e=Math.sin(t),i=Math.cos(t),r=Math.cos(2*t);this.cameraPosition[0]=23*e,this.cameraPosition[1]=23*i,this.cameraPosition[2]=12+6*r,function(t,e,i,r){var s,o,n,a,h,l,d,u,m,c,g=e[0],f=e[1],T=e[2],x=r[0],E=r[1],_=r[2],A=i[0],p=i[1],v=i[2];Math.abs(g-A)<1e-6&&Math.abs(f-p)<1e-6&&Math.abs(T-v)<1e-6?D(t):(d=g-A,u=f-p,m=T-v,s=E*(m*=c=1/Math.hypot(d,u,m))-_*(u*=c),o=_*(d*=c)-x*m,n=x*u-E*d,(c=Math.hypot(s,o,n))?(s*=c=1/c,o*=c,n*=c):(s=0,o=0,n=0),a=u*n-m*o,h=m*s-d*n,l=d*o-u*s,(c=Math.hypot(a,h,l))?(a*=c=1/c,h*=c,l*=c):(a=0,h=0,l=0),t[0]=s,t[1]=a,t[2]=d,t[3]=0,t[4]=o,t[5]=h,t[6]=u,t[7]=0,t[8]=n,t[9]=l,t[10]=m,t[11]=0,t[12]=-(s*g+o*f+n*T),t[13]=-(a*g+h*f+l*T),t[14]=-(d*g+u*f+m*T),t[15]=1)}(this.mVMatrix,this.cameraPosition,[0,0,12],[0,0,1])}else this.mVMatrix=this.customCamera}drawScene(){this.loaded&&(this.positionCamera(0),this.setCameraFOV(1),this.gl.clearColor(0,0,0,1),this.gl.colorMask(!1,!1,!1,!1),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.fboOffscreen.framebufferHandle),this.gl.viewport(0,0,this.fboOffscreen.width,this.fboOffscreen.height),this.gl.depthMask(!0),this.gl.enable(this.gl.DEPTH_TEST),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),this.drawDepthObjects(),this.gl.clearColor(.5,.5,.5,1),this.gl.enable(this.gl.DEPTH_TEST),this.gl.enable(this.gl.CULL_FACE),this.gl.cullFace(this.gl.BACK),this.gl.colorMask(!0,!0,!0,!0),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.gl.viewport(0,0,this.gl.canvas.width,this.gl.canvas.height),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),this.drawSceneObjects())}drawTestDepth(){this.gl.enable(this.gl.CULL_FACE),this.gl.cullFace(this.gl.BACK),this.gl.disable(this.gl.BLEND),this.shaderDiffuse.use(),this.setTexture2D(0,this.textureOffscreenDepth,this.shaderDiffuse.sTexture),this.drawVignette(this.shaderDiffuse)}drawSceneVignette(){this.shaderDiffuseOneChannel.use(),this.setTexture2D(0,this.textureVignette,this.shaderDiffuseOneChannel.sTexture),this.drawVignette(this.shaderDiffuseOneChannel)}drawVignette(t){this.unbindBuffers(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.mTriangleVerticesVignette),this.gl.enableVertexAttribArray(t.rm_Vertex),this.gl.vertexAttribPointer(t.rm_Vertex,3,this.gl.FLOAT,!1,20,0),this.gl.enableVertexAttribArray(t.rm_TexCoord0),this.gl.vertexAttribPointer(t.rm_TexCoord0,2,this.gl.FLOAT,!1,20,12),this.gl.uniformMatrix4fv(t.view_proj_matrix,!1,this.getOrthoMatrix()),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,4)}drawDepthObjects(){var t;void 0!==this.shaderDepthAnimated&&void 0!==this.shaderDiffuseAnimatedTexture&&void 0!==this.shaderDiffuseAnimatedTextureChunked&&void 0!==this.shaderAtAnimatedTextureChunked&&void 0!==this.shaderLitAnimatedTextureChunked&&void 0!==this.shaderDiffuseColored&&null!=this.shaderBend?(this.gl.enable(this.gl.CULL_FACE),this.gl.cullFace(this.gl.BACK),null===(t=this.shaderDepthAnimated)||void 0===t||t.use(),this.drawAnimated(this.shaderDepthAnimated,this.timerCharacterAnimation,this.animationsBody[this.currentAnimation],this.fmBody,this.textureBodyAnim,this.REAPER_ANIMATION_TEXTURE_WIDTH,"animateStartToEnd"),this.drawAnimated(this.shaderDepthAnimated,this.timerCharacterAnimation,this.animationsScythe[this.currentAnimation],this.fmScythe,this.textureScytheAnim,608,"animateStartToEnd"),this.gl.disable(this.gl.CULL_FACE),this.shaderAtAnimatedTextureChunked.use(),this.setTexture2D(1,this.textureCloth,this.shaderAtAnimatedTextureChunked.sTexture),this.drawAnimated(this.shaderAtAnimatedTextureChunked,this.timerCharacterAnimation,this.animationsCloth[this.currentAnimation],this.fmCloth,this.textureClothAnim,664,"animateStartToEnd"),this.gl.enable(this.gl.CULL_FACE)):console.log("undefined shaders")}drawSceneObjects(){if(void 0===this.shaderDiffuse||void 0===this.shaderDiffuseAlpha||void 0===this.shaderDiffuseAnimatedTexture||void 0===this.shaderDiffuseAnimatedTextureChunked||void 0===this.shaderDiffuseAnimatedTextureChunkedColored||void 0===this.shaderAtAnimatedTextureChunked||void 0===this.shaderLitAnimatedTextureChunked||void 0===this.shaderDiffuseColored||void 0===this.shaderSoftDiffuseColored||void 0===this.shaderSky||null==this.shaderBend)return void console.log("undefined shaders");this.gl.cullFace(this.gl.BACK),this.gl.disable(this.gl.BLEND);const t=this.getLightningIntensity();this.gl.disable(this.gl.CULL_FACE),this.shaderAtAnimatedTextureChunked.use(),this.setTexture2D(1,this.textureCloth,this.shaderAtAnimatedTextureChunked.sTexture),this.drawAnimated(this.shaderAtAnimatedTextureChunked,this.timerCharacterAnimation,this.animationsCloth[this.currentAnimation],this.fmCloth,this.textureClothAnim,664,"animateStartToEnd"),this.gl.enable(this.gl.CULL_FACE),this.shaderLitAnimatedTextureChunked.use(),t>0?(this.gl.uniform4f(this.shaderLitAnimatedTextureChunked.uLightDir,this.lightningDirection[0],this.lightningDirection[1],this.lightningDirection[2],0),this.gl.uniform4f(this.shaderLitAnimatedTextureChunked.uLightColor,1,1,1,0),this.gl.uniform1f(this.shaderLitAnimatedTextureChunked.uLightIntensity,t)):(this.gl.uniform4f(this.shaderLitAnimatedTextureChunked.uLightDir,0,0,-1,0),this.gl.uniform4f(this.shaderLitAnimatedTextureChunked.uLightColor,-1,-1,-1,0),this.gl.uniform1f(this.shaderLitAnimatedTextureChunked.uLightIntensity,.7)),this.setTexture2D(1,this.textureBody,this.shaderLitAnimatedTextureChunked.sTexture),this.setTexture2D(2,this.textureBodyNormalsAnim,this.shaderLitAnimatedTextureChunked.sNormals),this.drawAnimated(this.shaderLitAnimatedTextureChunked,this.timerCharacterAnimation,this.animationsBody[this.currentAnimation],this.fmBody,this.textureBodyAnim,this.REAPER_ANIMATION_TEXTURE_WIDTH,"animateStartToEnd"),this.setTexture2D(2,this.textureScytheNormalsAnim,this.shaderLitAnimatedTextureChunked.sNormals),this.drawAnimated(this.shaderLitAnimatedTextureChunked,this.timerCharacterAnimation,this.animationsScythe[this.currentAnimation],this.fmScythe,this.textureScytheAnim,608,"animateStartToEnd"),this.gl.depthMask(!1),this.shaderDiffuseAnimatedTextureChunkedColored.use();const e=this.getEyesOpacity();this.gl.uniform4f(this.shaderDiffuseAnimatedTextureChunkedColored.uColor,this.PRESET.colorEyes.r*e,this.PRESET.colorEyes.g*e,this.PRESET.colorEyes.b*e,this.PRESET.colorEyes.a*e),this.gl.disable(this.gl.CULL_FACE),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.ONE,this.gl.ONE),this.setTexture2D(1,this.textureEyes,this.shaderDiffuseAnimatedTextureChunkedColored.sTexture),this.drawAnimated(this.shaderDiffuseAnimatedTextureChunkedColored,this.timerCharacterAnimation,this.animationsEyes[this.currentAnimation],this.fmEyes,this.textureEyesAnim,36,"animateStartToEnd"),this.gl.disable(this.gl.BLEND),this.gl.depthMask(!0),this.gl.enable(this.gl.CULL_FACE),this.gl.depthMask(!1),this.shaderSky.use(),this.setTexture2D(0,this.textureSky,this.shaderSky.sTexture),this.setTexture2D(1,this.textureDisplacement,this.shaderSky.sDisplacement),this.shaderSky.setColor(1,1,1,1),this.shaderSky.setColor(.7,.6,.4,1),this.shaderSky.setColor(.51,.72,.9,1),this.shaderSky.setColor(.65,.35,.32,1),this.shaderSky.setColor(.38,.6,.4,1),this.shaderSky.setColor(.72,.7,.43,1),this.shaderSky.setColor(this.PRESET.colorSky.r,this.PRESET.colorSky.g,this.PRESET.colorSky.b,this.PRESET.colorSky.a),this.gl.uniform1f(this.shaderSky.uTime,this.timerSkyAnimation),this.gl.uniform1f(this.shaderSky.uLightning,5*t),this.gl.uniform4f(this.shaderSky.uLightningExponent,3.3,3.3,3.3,3.3),this.shaderSky.drawModel(this,this.fmSky,this.cameraPosition[0],this.cameraPosition[1],this.cameraPosition[2],0,0,this.timerSkyRotation*Math.PI*2,1,1,1),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA),this.drawParticles(),this.drawGhosts(),this.gl.blendFunc(this.gl.ONE,this.gl.ONE),this.drawDust(t),this.gl.blendFunc(this.gl.DST_COLOR,this.gl.SRC_COLOR),this.drawSceneVignette(),this.gl.disable(this.gl.BLEND),this.gl.depthMask(!0)}drawParticles(){if(void 0!==this.shaderSoftDiffuseColored&&void 0!==this.shaderSoftDiffuseColoredAlpha){this.shaderSoftDiffuseColoredAlpha.use(),this.initDepthReadShader(this.shaderSoftDiffuseColoredAlpha),this.setTexture2D(0,this.textureSmoke,this.shaderSoftDiffuseColoredAlpha.sTexture);for(let t=0;t<et.length;t++){const e=et[t],i=(this.timerSmokeMovement+13.37*t)%1,r=35*t+this.timerSmokeRotation*(t%2==0?360:-360);let s=e[0],o=e[1],n=e[2]+i*this.SMOKE_TRAVEL_Z;const a=i*this.SMOKE_SCALE,h=this.smootherstep(0,.4,i)*(1-this.smootherstep(.7,1,i));n+=4,this.gl.uniform4f(this.shaderSoftDiffuseColoredAlpha.color,this.PRESET.colorSmoke.r,this.PRESET.colorSmoke.g,this.PRESET.colorSmoke.b,this.PRESET.colorSmoke.a*h),this.drawDiffuseVBOFacingCamera(this.shaderSoftDiffuseColoredAlpha,this.fmSmoke,s,o,n,a,1,1,r)}for(let t=0;t<et.length/2;t++){const e=et[t],i=(this.timerSmokeMovement+13.37*t)%1,r=35*t+this.timerSmokeRotation*(t%2==0?360:-360);let s=e[0],o=e[1],n=e[2]+i*this.SMOKE_TRAVEL_Z*-.65;const a=i*this.SMOKE_SCALE*1.4,h=.6*this.smootherstep(0,.4,i)*(1-this.smootherstep(.7,1,i));n+=15,this.gl.uniform4f(this.shaderSoftDiffuseColoredAlpha.color,this.PRESET.colorSmoke.r,this.PRESET.colorSmoke.g,this.PRESET.colorSmoke.b,this.PRESET.colorSmoke.a*h),this.drawDiffuseVBOFacingCamera(this.shaderSoftDiffuseColoredAlpha,this.fmSmoke,s,o,n,a,1,1,r)}}else console.log("undefined shaders")}drawGhosts(){void 0!==this.shaderBend&&(this.gl.disable(this.gl.CULL_FACE),this.gl.depthMask(!1),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA),this.shaderBend.use(),this.shaderBend.setColor(0,0,0,1),this.setTexture2D(0,this.textureParticle,this.shaderBend.sTexture),this.shaderBend.setColor(.05,.05,.05,.35),this.shaderBend.setRadius(9+3*(1+Math.sin(this.timerGhostsRotation2*Math.PI*2))),this.shaderBend.setLength(.3),this.shaderBend.drawModel(this,this.fmStripe,0,0,12+.4*Math.sin(this.timerGhostsRotation*Math.PI*4),.2,.3,(1.5-this.timerGhostsRotation)*Math.PI*2,1,1,.18+.06*Math.sin(this.timerGhostsRotation2*Math.PI*2)),this.shaderBend.setRadius(9.5+3*(1+Math.sin((this.timerGhostsRotation2+.3)*Math.PI*2))),this.shaderBend.drawModel(this,this.fmStripe,0,0,10-.4*Math.sin((this.timerGhostsRotation+.3)*Math.PI*4),-.1,.3,(.73-this.timerGhostsRotation)*Math.PI*2,1,1,.2+.06*Math.sin(this.timerGhostsRotation2*Math.PI*2)),this.shaderBend.setRadius(10-3*(1+Math.sin((this.timerGhostsRotation2+.55)*Math.PI*2))),this.shaderBend.setLength(-.3),this.shaderBend.drawModel(this,this.fmStripe,0,0,15+.3*Math.sin((this.timerGhostsRotation+.6)*Math.PI*4),-.2,-.3,this.timerGhostsRotation*Math.PI*2,1,1,.2+.06*Math.sin(this.timerGhostsRotation2*Math.PI*2)),this.shaderBend.setRadius(8+3*(1+Math.sin((this.timerGhostsRotation2+.83)*Math.PI*2))),this.shaderBend.drawModel(this,this.fmStripe,0,0,7-.3*Math.sin((this.timerGhostsRotation+.8)*Math.PI*4),.1,-.3,(1.3+this.timerGhostsRotation)*Math.PI*2,1,1,.15+.06*Math.sin(this.timerGhostsRotation2*Math.PI*2)),this.gl.enable(this.gl.CULL_FACE))}drawDust(t){if(void 0===this.shaderPointSpriteColored)return;const e=360*this.timerDustRotation,i=360*-this.timerDustRotation*2,r=.5+Math.sin(this.timerDustFlickering*Math.PI*2)/2,s=.5+Math.sin((this.timerDustFlickering+.3)*Math.PI*2)/2,o=.5+Math.sin((this.timerDustFlickering+.5)*Math.PI*2)/2,n=.5+Math.sin((this.timerDustFlickering+.6)*Math.PI*2)/2;this.shaderPointSpriteColored.use(),this.setTexture2D(0,this.textureDust,this.shaderPointSpriteColored.tex0),this.gl.uniform1f(this.shaderPointSpriteColored.uThickness,this.dustSpriteSize);const a=this.DUST_COLOR.r*t,h=this.DUST_COLOR.g*t,l=this.DUST_COLOR.b*t;this.gl.uniform4f(this.shaderPointSpriteColored.color,this.DUST_COLOR.r*r+a,this.DUST_COLOR.g*r+h,this.DUST_COLOR.b*r+l,this.DUST_COLOR.a),this.drawPointSpritesVBOTranslatedRotatedScaled(this.shaderPointSpriteColored,this.fmDust,0,2,11,e,i,e,this.DUST_SCALE,this.DUST_SCALE,this.DUST_SCALE),this.gl.uniform4f(this.shaderPointSpriteColored.color,this.DUST_COLOR.r*s+a,this.DUST_COLOR.g*s+h,this.DUST_COLOR.b*s+l,this.DUST_COLOR.a),this.drawPointSpritesVBOTranslatedRotatedScaled(this.shaderPointSpriteColored,this.fmDust,1,-2,12,i,-e,i,this.DUST_SCALE,this.DUST_SCALE,this.DUST_SCALE),this.gl.uniform4f(this.shaderPointSpriteColored.color,this.DUST_COLOR.r*o+a,this.DUST_COLOR.g*o+h,this.DUST_COLOR.b*o+l,this.DUST_COLOR.a),this.drawPointSpritesVBOTranslatedRotatedScaled(this.shaderPointSpriteColored,this.fmDust,3,-1,13,-i,-e,-i,this.DUST_SCALE,this.DUST_SCALE,this.DUST_SCALE),this.gl.uniform4f(this.shaderPointSpriteColored.color,this.DUST_COLOR.r*n+a,this.DUST_COLOR.g*n+h,this.DUST_COLOR.b*n+l,this.DUST_COLOR.a),this.drawPointSpritesVBOTranslatedRotatedScaled(this.shaderPointSpriteColored,this.fmDust,2,-2,14,-e,-e,i,this.DUST_SCALE,this.DUST_SCALE,this.DUST_SCALE)}drawAnimated(t,e,i,r,s,o=this.ANIMATION_TEXTURE_WIDTH,n="animateStartEndStart"){this.gl.uniform1i(t.uTextureWidthInt,o),this.setTexture2D(0,s,t.sPositions),this.gl.uniform4f(t.uTexelSizes,i.textureWidth,i.texelHalfWidth,i[n](e),i.chunkSize),this.gl.uniform1f(t.uTexelHeight,1/i.textureHeight),t.drawModel(this,r,0,0,0,0,0,0,this.SCALE,this.SCALE,this.SCALE)}clamp(t,e,i){return Math.max(Math.min(t,i),e)}randomizeCamera(){this.currentRandomCamera=(this.currentRandomCamera+1+Math.trunc(Math.random()*(this.CAMERAS.length-2)))%this.CAMERAS.length,this.cameraPositionInterpolator.speed=this.CAMERA_SPEED*this.CAMERAS[this.currentRandomCamera].speedMultiplier,this.cameraPositionInterpolator.position=this.CAMERAS[this.currentRandomCamera],this.cameraPositionInterpolator.reset()}randomizeLightning(){!function(t,e){e=e||1;var i=2*M()*Math.PI,r=2*M()-1,s=Math.sqrt(1-r*r)*e;t[0]=Math.cos(i)*s,t[1]=Math.sin(i)*s,t[2]=r*e}(this.lightningDirection,1)}drawPointSpritesVBOTranslatedRotatedScaled(t,e,i,r,s,o,n,a,h,l,d){e.bindBuffers(this.gl),this.gl.enableVertexAttribArray(t.aPosition),this.gl.vertexAttribPointer(t.aPosition,3,this.gl.FLOAT,!1,20,0),this.calculateMVPMatrix(i,r,s,o,n,a,h,l,d),this.gl.uniformMatrix4fv(t.uMvp,!1,this.mMVPMatrix),this.gl.drawElements(this.gl.POINTS,3*e.getNumIndices(),this.gl.UNSIGNED_SHORT,0)}drawDiffuseVBOFacingCamera(t,e,i,r,s,o,n,a,h){e.bindBuffers(this.gl),this.gl.enableVertexAttribArray(t.rm_Vertex),this.gl.enableVertexAttribArray(t.rm_TexCoord0),this.gl.vertexAttribPointer(t.rm_Vertex,3,this.gl.FLOAT,!1,20,0),this.gl.vertexAttribPointer(t.rm_TexCoord0,2,this.gl.FLOAT,!1,20,12),this.calculateMVPMatrixForSprite(i,r,s,o,n,a,h),this.gl.uniformMatrix4fv(t.view_proj_matrix,!1,this.mMVPMatrix),this.gl.drawElements(this.gl.TRIANGLES,3*e.getNumIndices(),this.gl.UNSIGNED_SHORT,0),this.checkGlError("glDrawElements")}calculateMVPMatrixForSprite(t,e,i,r,s,o,n){D(this.mMMatrix),b(this.mMMatrix,this.mMMatrix,[t,e,i]),function(t,e,i){var r=i[0],s=i[1],o=i[2];t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t[4]=e[4]*s,t[5]=e[5]*s,t[6]=e[6]*s,t[7]=e[7]*s,t[8]=e[8]*o,t[9]=e[9]*o,t[10]=e[10]*o,t[11]=e[11]*o,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]}(this.mMMatrix,this.mMMatrix,[r,s,o]),F(this.mMVPMatrix,this.mVMatrix,this.mMMatrix),this.resetMatrixRotations(this.mMVPMatrix),U(this.mMVPMatrix,this.mMVPMatrix,n),F(this.mMVPMatrix,this.mProjMatrix,this.mMVPMatrix)}resetMatrixRotations(t){const e=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);t[0]=e,t[4]=0,t[8]=0,t[1]=0,t[5]=e,t[9]=0,t[2]=0,t[6]=0,t[10]=e,t[3]=0,t[7]=0,t[11]=0,t[15]=1}initDepthReadShader(t){this.gl.uniform2f(t.cameraRange,this.Z_NEAR,this.Z_FAR),this.gl.uniform2f(t.invViewportSize,1/this.gl.canvas.width,1/this.gl.canvas.height),this.gl.uniform1f(t.transitionSize,this.SMOKE_SOFTNESS),this.setTexture2D(2,this.textureOffscreenDepth,t.sDepth)}smootherstep(t,e,i){return(i=this.clamp((i-t)/(e-t),0,1))*i*i*(i*(6*i-15)+10)}getEyesOpacity(){const t=this.timerEyes*Math.PI*2;return.125+.5*(Math.sin(t)+1)}getLightningIntensity(){const t=this.timerLightning*Math.PI*2,e=Math.sin(.2*t)-Math.cos(2.34*t)+Math.sin(15.13*t)+Math.cos(23.55*t)-2;return e>0?e:0}}class rt{constructor(t){var e,i;this._dirty=!0,this._angles=N(),this._position=N(),this.speed=100,this.rotationSpeed=.025,this._cameraMat=w(),this._viewMat=w(),this.projectionMat=w(),this.pressedKeys=new Array,this.canvas=t.canvas,this.speed=null!==(e=t.movementSpeed)&&void 0!==e?e:100,this.rotationSpeed=null!==(i=t.rotationSpeed)&&void 0!==i?i:.025;let r,s,o=!1;window.addEventListener("keydown",(t=>this.pressedKeys[t.keyCode]=!0)),window.addEventListener("keyup",(t=>this.pressedKeys[t.keyCode]=!1)),this.canvas.addEventListener("contextmenu",(t=>t.preventDefault())),this.canvas.addEventListener("mousedown",(t=>{3===t.which&&(o=!0),r=t.pageX,s=t.pageY})),this.canvas.addEventListener("mousemove",(t=>{if(o){let e=t.pageX-r,i=t.pageY-s;r=t.pageX,s=t.pageY,this.angles[1]+=e*this.rotationSpeed,this.angles[1]<0&&(this.angles[1]+=2*Math.PI),this.angles[1]>=2*Math.PI&&(this.angles[1]-=2*Math.PI),this.angles[0]+=i*this.rotationSpeed,this.angles[0]<.5*-Math.PI&&(this.angles[0]=.5*-Math.PI),this.angles[0]>.5*Math.PI&&(this.angles[0]=.5*Math.PI),this._dirty=!0}})),this.canvas.addEventListener("mouseup",(t=>o=!1))}get angles(){return this._angles}set angles(t){this._angles=t,this._dirty=!0}get position(){return this._position}set position(t){this._position=t,this._dirty=!0}get viewMat(){if(this._dirty){var t=this._viewMat;D(t),I(t,t,this.angles[0]-Math.PI/2),U(t,t,this.angles[1]),L(t,t,this.angles[2]),b(t,t,[-this.position[0],-this.position[1],-this.position[2]]),this._dirty=!1}return this._viewMat}update(t){const e=N();let i=this.speed/1e3*t;if(this.pressedKeys[16]&&(i*=5),this.pressedKeys["W".charCodeAt(0)]&&(e[1]+=i),this.pressedKeys["S".charCodeAt(0)]&&(e[1]-=i),this.pressedKeys["A".charCodeAt(0)]&&(e[0]-=i),this.pressedKeys["D".charCodeAt(0)]&&(e[0]+=i),this.pressedKeys[32]&&(e[2]+=i),this.pressedKeys["C".charCodeAt(0)]&&(e[2]-=i),0!==e[0]||0!==e[1]||0!==e[2]){let t=this._cameraMat;D(t),I(t,t,this.angles[0]),U(t,t,this.angles[1]),P(t,t),function(t,e,i){var r=e[0],s=e[1],o=e[2],n=i[3]*r+i[7]*s+i[11]*o+i[15];n=n||1,t[0]=(i[0]*r+i[4]*s+i[8]*o+i[12])/n,t[1]=(i[1]*r+i[5]*s+i[9]*o+i[13])/n,t[2]=(i[2]*r+i[6]*s+i[10]*o+i[14])/n}(e,e,t),function(t,e,i){t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2]}(this.position,this.position,e),this._dirty=!0}}}var st,ot;!function(t){t[t.Free=0]="Free",t[t.Predefined=1]="Predefined"}(st||(st={}));class nt{constructor(t,e){this.renderer=t,this.options=e,this.matCamera=w(),this.matInvCamera=new Float32Array(16),this.vec3Eye=new Float32Array(3),this.vec3Rotation=new Float32Array(3),this.mode=st.Predefined,this.setupControls()}setupControls(){document.addEventListener("keypress",(t=>{var e;if("Enter"===t.code)if(this.mode===st.Predefined){this.matCamera=function(t){var e=new y(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}(this.renderer.getViewMatrix()),this.renderer.setCustomCamera(this.matCamera),this.mode=st.Free,P(this.matInvCamera,this.matCamera),function(t,e){t[0]=e[12],t[1]=e[13],t[2]=e[14]}(this.vec3Eye,this.matInvCamera),function(t,e){var i=e[0],r=e[1],s=e[2],o=i*i+r*r+s*s;o>0&&(o=1/Math.sqrt(o)),t[0]=e[0]*o,t[1]=e[1]*o,t[2]=e[2]*o}(this.vec3Rotation,this.vec3Eye),function(t,e,i){t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i}(this.vec3Rotation,this.vec3Rotation,-1),this.fpsCamera=null!==(e=this.fpsCamera)&&void 0!==e?e:new rt(this.options),this.fpsCamera.position=this.vec3Eye;const t=e=>{this.mode===st.Free&&(this.fpsCamera.update(16),this.matCamera=this.fpsCamera.viewMat,this.renderer.setCustomCamera(this.matCamera,this.fpsCamera.position,this.fpsCamera.angles),requestAnimationFrame(t))};t()}else this.renderer.resetCustomCamera(),this.mode=st.Predefined}))}}ot=()=>{const e="#nolights"===new URL(window.location.href).hash,i=new it;i.lightning=!e,i.init("canvasGL",!0);const r=document.getElementById("canvasGL");new nt(i,{canvas:r,movementSpeed:25,rotationSpeed:.006});const s=new t;document.getElementById("toggleFullscreen").addEventListener("click",(()=>{document.body.classList.contains("fs")?s.exitFullScreen():s.enterFullScreen(),s.addFullScreenListener((function(){s.isFullScreen()?document.body.classList.add("fs"):document.body.classList.remove("fs")}))})),r.addEventListener("click",(()=>i.changeScene()))},"loading"!==document.readyState?ot():document.addEventListener("DOMContentLoaded",ot);
//# sourceMappingURL=index.min.js.map
